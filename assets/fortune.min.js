/*!
 * Fortune.js
 * Version 4.0.2
 * MIT License
 * http://fortunejs.com
 */
!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(Buffer){"use strict";function check(type,a,b){var matcher;return null===b?null===a:(matcher=find(matchCheck,function(pair){return pair[0]===type}),matcher?matcher[1](a,b):type&&type.equal?type.equal(a,b):a===b)}function checkValue(fieldDefinition,a){return function(b){return fieldDefinition[isArrayKey]?find(a,function(a){return check(fieldDefinition[typeKey],b,a)}):check(fieldDefinition[typeKey],b,a)}}function matchByField(fields,match,record){var field,matches;for(field in match)if(matches=match[field],Array.isArray(matches)||(matches=[matches]),void 0===find(matches,checkValue(fields[field],record[field])))return!1;return!0}function matchByExistence(fields,exists,record){var field,value,isArray;for(field in exists)if(value=record[field],isArray=fields[field][isArrayKey],exists[field]){if(!value)return!1;if(isArray&&!value.length)return!1}else{if(value&&!isArray)return!1;if(isArray&&value.length)return!1}return!0}function matchByRange(fields,ranges,record){var field,fieldDefinition,fieldType,fieldIsArray,range,value,compare={};for(field in ranges)if(fieldDefinition=fields[field],fieldType=fieldDefinition[typeKey],fieldIsArray=fieldDefinition[isArrayKey],fieldType||fieldIsArray){if(range=ranges[field],value=record[field],null==value)return!1;if(fieldIsArray&&(value=value?value.length:0),!compare[field])if(fieldIsArray)compare[field]=find(comparisons,findKey(Number))[1];else if(compare[field]=fieldType.compare||find(comparisons,findKey(fieldType))[1],!compare[field])throw new Error('Missing "compare" function.');if(null!==range[0]&&compare[field](value,range[0])<0)return!1;if(null!==range[1]&&compare[field](range[1],value)<0)return!1}return!0}function findKey(key){return function(pair){return pair[0]===key}}function compare(fields,sort){var field,compare,a,b,isAscending,fieldDefinition,fieldIsArray,fieldType,result;return function(x,y){for(field in sort){if(a=x[field],b=y[field],isAscending=sort[field],fieldDefinition=fields[field],fieldIsArray=fieldDefinition[isArrayKey],fieldType=fieldDefinition[typeKey],null===a)return 1;if(null===b)return-1;if(result=0,fieldIsArray)result=a.length-b.length;else if(fieldType){if(compare=fieldType.compare||find(comparisons,findKey(fieldType))[1],!compare)throw new Error('Missing "compare" function.');result=compare(a,b)}if(0!==result)return isAscending?result:-result}return 0}}var deepEqual=require("../../common/deep_equal"),message=require("../../common/message"),find=require("../../common/array/find"),errors=require("../../common/errors"),BadRequestError=errors.BadRequestError,keys=require("../../common/keys"),primaryKey=keys.primary,typeKey=keys.type,isArrayKey=keys.isArray,matchCheck=[[Date,function(a,b){return a.getTime()===b.getTime()}],[Buffer,function(a,b){return a.equals(b)}],[Object,function(a,b){return deepEqual(a,b)}]],comparisons=[[Number,function(a,b){return a-b}],[String,function(a,b){return b>a?-1:a>b?1:0}],[Boolean,function(a,b){return a===b?0:a?1:-1}],[Date,function(a,b){return a.getTime()-b.getTime()}],[Buffer,Buffer.compare],[Object,function(a,b){return Object.keys(a).length-Object.keys(b).length}]];exports.generateId=function(){return Date.now()+"-"+("00000000"+Math.floor(Math.random()*Math.pow(2,32)).toString(16)).slice(-8)},exports.applyOptions=function(fields,records,options,meta){var count,record,field,isInclude,isExclude,language,memoizedRecords,range,match,exists,i,j;if(options||(options={}),meta||(meta={}),language=meta.language,range=options.range,match=options.match,exists=options.exists,range||match||exists)for(memoizedRecords=records,records=[],i=0,j=memoizedRecords.length;j>i;i++)record=memoizedRecords[i],range&&!matchByRange(fields,range,record)||match&&!matchByField(fields,match,record)||exists&&!matchByExistence(fields,exists,record)||records.push(record);if(count=records.length,"fields"in options){if(isInclude=!find(Object.keys(options.fields),function(field){return!options.fields[field]}),isExclude=!find(Object.keys(options.fields),function(field){return options.fields[field]}),!isInclude&&!isExclude)throw new BadRequestError(message("FieldsFormat",language));for(i=0,j=records.length;j>i;i++){record=records[i];for(field in record)field!==primaryKey&&(isInclude&&!(field in options.fields)||isExclude&&field in options.fields)&&delete record[field]}}return"sort"in options&&(records=records.sort(compare(fields,options.sort))),("limit"in options||"offset"in options)&&(records=records.slice(options.offset,options.limit?(options.offset||0)+options.limit:records.length)),records.count=count,records}}).call(this,require("buffer").Buffer)},{"../../common/array/find":11,"../../common/deep_equal":20,"../../common/errors":21,"../../common/keys":24,"../../common/message":25,buffer:47}],2:[function(require,module,exports){"use strict";var common=require("../common"),generateId=common.generateId,delimiter="__";exports.delimiter=delimiter,exports.inputRecord=function(type,record){var i,j,field,fieldIsArray,recordTypes=this.recordTypes,primaryKey=this.keys.primary,isArrayKey=this.keys.isArray,fields=recordTypes[type],fieldsArray=Object.getOwnPropertyNames(fields),result={};result[primaryKey]=type+delimiter+(primaryKey in record?record[primaryKey]:generateId());for(i=0,j=fieldsArray.length;j>i;i++)field=fieldsArray[i],fieldIsArray=fields[field][isArrayKey],field in record?result[field]=record[field]:result[field]=fieldIsArray?[]:null;return result},exports.outputRecord=function(type,record){var i,j,field,fieldIsArray,fieldIsDenormalized,value,recordTypes=this.recordTypes,primaryKey=this.keys.primary,isArrayKey=this.keys.isArray,denormalizedInverseKey=this.keys.denormalizedInverse,fields=recordTypes[type],fieldsArray=Object.getOwnPropertyNames(fields),result={},id=record[primaryKey].split(delimiter)[1],float=Number.parseFloat(id);for(result[primaryKey]=id-float+1>=0?float:id,i=0,j=fieldsArray.length;j>i;i++)field=fieldsArray[i],fieldIsArray=fields[field][isArrayKey],value=field in record?record[field]:fieldIsArray?[]:null,fieldIsDenormalized=fields[field][denormalizedInverseKey],fieldIsDenormalized?Object.defineProperty(result,field,{configurable:!0,writable:!0,value:value}):field in record&&(result[field]=value);return result}},{"../common":1}],3:[function(require,module,exports){"use strict";var msgpack=require("msgpack-lite"),reduce=require("../../../common/array/reduce"),includes=require("../../../common/array/includes"),memoryAdapter=require("../memory"),common=require("../common"),generateId=common.generateId,constants=require("../../../common/constants"),internalKey=constants.internal,primaryKey=constants.primary,worker=require("./worker"),helpers=require("./helpers"),inputRecord=helpers.inputRecord,outputRecord=helpers.outputRecord,delimiter=helpers.delimiter;module.exports=function(Adapter){function IndexedDBAdapter(properties){MemoryAdapter.call(this,properties),this.options.name||(this.options.name="fortune"),this.worker=new Worker(objectURL)}var MemoryAdapter=memoryAdapter(Adapter),script=['var primaryKey = "'+primaryKey+'"','var delimiter = "'+delimiter+'"','var dataKey = "__data"',"("+worker.toString()+")()",includes.toString()].join(";"),blob=new Blob([script],{type:"text/javascript"}),objectURL=URL.createObjectURL(blob);return Object.defineProperty(IndexedDBAdapter,internalKey,{value:!0}),IndexedDBAdapter.prototype=Object.create(MemoryAdapter.prototype),IndexedDBAdapter.prototype.connect=function(){function reducer(type,records){return reduce(records,function(hash,record){return record=outputRecord.call(self,type,msgpack.decode(record)),hash[record[primaryKey]]=record,hash},{})}var self=this,Promise=self.Promise,typesArray=Object.keys(self.recordTypes),name=self.options.name,id=generateId();return MemoryAdapter.prototype.connect.call(self).then(function(){return new Promise(function(resolve,reject){function listener(event){var type,data=event.data,result=data.result;if(data.id!==id)return null;if(data.error)return reject(new Error(data.error));self.worker.removeEventListener("message",listener);for(type in result)self.db[type]=reducer(type,result[type]);return resolve()}self.worker.addEventListener("message",listener),self.worker.postMessage({id:id,method:"connect",name:name,typesArray:typesArray})})})},IndexedDBAdapter.prototype.disconnect=function(){return this.worker.postMessage({method:"disconnect"}),MemoryAdapter.prototype.disconnect.call(this)},IndexedDBAdapter.prototype.create=function(type,records){var self=this,Promise=self.Promise;return MemoryAdapter.prototype.create.call(self,type,records).then(function(records){return records.length?new Promise(function(resolve,reject){function listener(event){var data=event.data;return data.id!==id?null:data.error?reject(new Error(data.error)):(self.worker.removeEventListener("message",listener),resolve(records))}var id=generateId(),transfer=[];self.worker.addEventListener("message",listener),self.worker.postMessage({id:id,method:"create",type:type,records:reduce(records,function(hash,record){var data=msgpack.encode(inputRecord.call(self,type,record));return transfer.push(data.buffer),hash[record[primaryKey]]=data,hash},{})},transfer)}):records})},IndexedDBAdapter.prototype.find=function(type,ids,options){return MemoryAdapter.prototype.find.call(this,type,ids,options)},IndexedDBAdapter.prototype.update=function(type,updates){var self=this,Promise=self.Promise,db=self.db,id=generateId();return MemoryAdapter.prototype.update.call(self,type,updates).then(function(count){return count?new Promise(function(resolve,reject){function listener(event){var data=event.data;return data.id!==id?null:data.error?reject(new Error(data.error)):(self.worker.removeEventListener("message",listener),resolve(count))}var i,j,record,records=[],transfer=[];for(i=0,j=updates.length;j>i;i++)record=db[type][updates[i][primaryKey]],record&&records.push(record);self.worker.addEventListener("message",listener),self.worker.postMessage({id:id,method:"update",type:type,records:reduce(records,function(hash,record){var data=msgpack.encode(inputRecord.call(self,type,record));return transfer.push(data.buffer),hash[record[primaryKey]]=data,hash},{})},transfer)}):count})},IndexedDBAdapter.prototype["delete"]=function(type,ids){var self=this,Promise=self.Promise,id=generateId();return MemoryAdapter.prototype["delete"].call(self,type,ids).then(function(count){return count?new Promise(function(resolve,reject){function listener(event){var data=event.data;return data.id!==id?null:data.error?reject(new Error(data.error)):(self.worker.removeEventListener("message",listener),resolve(count))}self.worker.addEventListener("message",listener),self.worker.postMessage({id:id,method:ids?"delete":"deleteAll",type:type,ids:ids})}):count})},IndexedDBAdapter}},{"../../../common/array/includes":12,"../../../common/array/reduce":15,"../../../common/constants":19,"../common":1,"../memory":6,"./helpers":2,"./worker":4,"msgpack-lite":54}],4:[function(require,module,exports){"use strict";function worker(){function connect(data,callback){function handleSuccess(event){var i,j;for(db=event.target.result,i=0,j=typesArray.length;j>i;i++)if(!includes(db.objectStoreNames,typesArray[i]))return void reconnect();loadRecords()}function handleUpgrade(event){var i,j,type;for(db=event.target.result,i=0,j=typesArray.length;j>i;i++)type=typesArray[i],includes(db.objectStoreNames,type)||db.createObjectStore(type,{keyPath:primaryKey});for(i=0,j=db.objectStoreNames.length;j>i;i++)type=db.objectStoreNames[i],includes(typesArray,type)||db.deleteObjectStore(type)}function reconnect(){var version=(db.version||1)+1;db.close(),request=indexedDB.open(data.name,version),request.onerror=errorReconnection,request.onupgradeneeded=handleUpgrade,request.onsuccess=function(event){db=event.target.result,loadRecords(db)}}function loadRecords(){function loadType(type){var transaction=db.transaction(type,"readonly"),objectStore=transaction.objectStore(type),cursor=objectStore.openCursor();payload[type]=[],cursor.onsuccess=function(event){var iterator=event.target.result;return iterator?(payload[type].push(iterator.value[dataKey]),transfer.push(iterator.value[dataKey].buffer),void iterator["continue"]()):(counter++,void(counter===typesArray.length&&callback(null,payload,transfer)))},cursor.onerror=errorIteration}var i,j,counter=0,payload={},transfer=[];for(i=0,j=typesArray.length;j>i;i++)loadType(typesArray[i])}function errorConnection(){callback("The database connection could not be established.")}function errorReconnection(){callback("An attempt to reconnect failed.")}function errorIteration(){callback("Failed to read record.")}var request=indexedDB.open(data.name),typesArray=data.typesArray;request.onerror=errorConnection,request.onupgradeneeded=handleUpgrade,request.onsuccess=handleSuccess}function disconnect(){db.close()}function create(data,callback){function check(){counter++,counter===recordsLength&&callback()}function error(){callback("A record could not be created.")}var id,record,object,request,recordsLength=Object.keys(data.records).length,type=data.type,transaction=db.transaction(type,"readwrite"),objectStore=transaction.objectStore(type),counter=0;for(id in data.records)record=data.records[id],object={},object[primaryKey]=id,object[dataKey]=record,request=objectStore.add(object),request.onsuccess=check,request.onerror=error}function update(data,callback){function check(){counter++,counter===recordsLength&&callback()}function error(){callback("A record could not be updated.")}var id,record,object,request,recordsLength=Object.keys(data.records).length,type=data.type,transaction=db.transaction(type,"readwrite"),objectStore=transaction.objectStore(type),counter=0;for(id in data.records)record=data.records[id],object={},object[primaryKey]=id,object[dataKey]=record,request=objectStore.put(object),request.onsuccess=check,request.onerror=error}function remove(data,callback){function check(){counter++,counter===ids.length&&callback()}function error(){callback("A record could not be deleted.")}var i,j,id,request,type=data.type,ids=data.ids,transaction=db.transaction(type,"readwrite"),objectStore=transaction.objectStore(type),counter=0;for(i=0,j=ids.length;j>i;i++)id=ids[i],request=objectStore["delete"](type+delimiter+id),request.onsuccess=check,request.onerror=error}function removeAll(data,callback){function error(){callback("Not all records could be deleted.")}var type=data.type,transaction=db.transaction(type,"readwrite"),objectStore=transaction.objectStore(type),request=objectStore.clear();request.onsuccess=function(){callback()},request.onerror=error}var db,indexedDB=self.indexedDB,methodMap={connect:connect,disconnect:disconnect,create:create,update:update,"delete":remove,deleteAll:removeAll};self.addEventListener("message",function(event){var data=event.data,id=data.id,method=data.method;methodMap[method](data,function(error,result,transfer){return error?void self.postMessage({id:id,error:error.toString()}):void self.postMessage({id:id,result:result},transfer)})})}module.exports=worker},{}],5:[function(require,module,exports){"use strict";var common=require("../common"),generateId=common.generateId;exports.inputRecord=function(type,record){var i,j,field,recordTypes=this.recordTypes,primaryKey=this.keys.primary,isArrayKey=this.keys.isArray,fields=recordTypes[type],fieldsArray=Object.getOwnPropertyNames(fields),result={};result[primaryKey]=primaryKey in record?record[primaryKey]:generateId();for(i=0,j=fieldsArray.length;j>i;i++)field=fieldsArray[i],field in record?result[field]=record[field]:result[field]=fields[field][isArrayKey]?[]:null;return result},exports.outputRecord=function(type,record){var i,j,field,value,recordTypes=this.recordTypes,primaryKey=this.keys.primary,isArrayKey=this.keys.isArray,denormalizedInverseKey=this.keys.denormalizedInverse,fields=recordTypes[type],fieldsArray=Object.getOwnPropertyNames(fields),result={};for(result[primaryKey]=record[primaryKey],i=0,j=fieldsArray.length;j>i;i++)field=fieldsArray[i],value=field in record?record[field]:fields[field][isArrayKey]?[]:null,fields[field][denormalizedInverseKey]?Object.defineProperty(result,field,{configurable:!0,writable:!0,value:value}):field in record&&(result[field]=value);return result}},{"../common":1}],6:[function(require,module,exports){"use strict";var applyUpdate=require("../../../common/apply_update"),map=require("../../../common/array/map"),constants=require("../../../common/constants"),internalKey=constants.internal,common=require("../common"),applyOptions=common.applyOptions,helpers=require("./helpers"),inputRecord=helpers.inputRecord,outputRecord=helpers.outputRecord;module.exports=function(Adapter){function MemoryAdapter(properties){Adapter.call(this,properties),this.options||(this.options={}),"recordsPerType"in this.options||(this.options.recordsPerType=1e3)}return Object.defineProperty(MemoryAdapter,internalKey,{value:!0}),MemoryAdapter.prototype=Object.create(Adapter.prototype),MemoryAdapter.prototype.connect=function(){var type,Promise=this.Promise,recordTypes=this.recordTypes;this.db={};for(type in recordTypes)this.db[type]={};return Promise.resolve()},MemoryAdapter.prototype.disconnect=function(){var Promise=this.Promise;return delete this.db,Promise.resolve()},MemoryAdapter.prototype.find=function(type,ids,options,meta){var i,j,id,record,self=this,Promise=self.Promise,db=self.db,recordTypes=self.recordTypes,fields=recordTypes[type],collection=db[type],records=[];if(ids&&!ids.length)return Adapter.prototype.find.call(self);if(ids)for(i=0,j=ids.length;j>i;i++)id=ids[i],id in collection&&(record=collection[id],delete collection[id],collection[id]=record,records.push(outputRecord.call(self,type,record)));else for(id in collection)records.push(outputRecord.call(self,type,collection[id]));return Promise.resolve(applyOptions(fields,records,options,meta))},MemoryAdapter.prototype.create=function(type,records,meta){var i,j,record,id,ids,language,self=this,message=self.message,Promise=self.Promise,db=self.db,recordsPerType=self.options.recordsPerType,primaryKey=self.keys.primary,ConflictError=self.errors.ConflictError,collection=db[type];for(meta||(meta={}),language=meta.language,records=map(records,function(record){return inputRecord.call(self,type,record)}),i=0,j=records.length;j>i;i++)if(record=records[i],id=record[primaryKey],collection[id])return Promise.reject(new ConflictError(message("RecordExists",language,{id:id})));for(i=0,j=records.length;j>i;i++)record=records[i],collection[record[primaryKey]]=record;return ids=Object.keys(collection),(recordsPerType&&ids.length>recordsPerType?self["delete"](type,ids.slice(0,ids.length-recordsPerType)):Promise.resolve()).then(function(){return map(records,function(record){return outputRecord.call(self,type,record)})})},MemoryAdapter.prototype.update=function(type,updates){var i,j,update,id,record,self=this,Promise=self.Promise,db=self.db,primaryKey=self.keys.primary,collection=db[type],count=0;if(!updates.length)return Adapter.prototype.update.call(self);for(i=0,j=updates.length;j>i;i++)update=updates[i],id=update[primaryKey],record=collection[id],record&&(count++,record=outputRecord.call(self,type,record),applyUpdate(record,update),delete collection[id],collection[id]=inputRecord.call(self,type,record));return Promise.resolve(count)},MemoryAdapter.prototype["delete"]=function(type,ids){var i,j,id,Promise=this.Promise,db=this.db,collection=db[type],count=0;if(ids&&!ids.length)return Adapter.prototype["delete"].call(this);if(ids)for(i=0,j=ids.length;j>i;i++)id=ids[i],collection[id]&&(delete collection[id],count++);else for(id in collection)delete collection[id],count++;return Promise.resolve(count)},MemoryAdapter}},{"../../../common/apply_update":10,"../../../common/array/map":13,"../../../common/constants":19,"../common":1,"./helpers":5}],7:[function(require,module,exports){"use strict";function Adapter(properties){assign(this,properties)}var assign=require("../common/assign");Adapter.prototype.constructor=function(){},delete Adapter.prototype.constructor,Adapter.prototype.connect=function(){return Promise.resolve()},Adapter.prototype.disconnect=function(){return Promise.resolve()},Adapter.prototype.create=function(){return Promise.resolve([])},Adapter.prototype.find=function(){var results=[];return results.count=0,Promise.resolve(results)},Adapter.prototype.update=function(){return Promise.resolve(0)},Adapter.prototype["delete"]=function(){return Promise.resolve(0)},Adapter.prototype.beginTransaction=function(){return Promise.resolve(this)},Adapter.prototype.endTransaction=function(){return Promise.resolve()},Adapter.prototype.applyOperators=function(record){return record},module.exports=Adapter},{"../common/assign":17}],8:[function(require,module,exports){"use strict";function AdapterSingleton(properties){var CustomAdapter,input;if(input=Array.isArray(properties.adapter)?properties.adapter:[properties.adapter],"function"!=typeof input[0])throw new TypeError("The adapter must be a function.");if(CustomAdapter=Adapter.prototype.isPrototypeOf(input[0].prototype)?input[0]:input[0](Adapter),!Adapter.prototype.isPrototypeOf(CustomAdapter.prototype))throw new TypeError("The adapter must inherit the Adapter class.");return new CustomAdapter(assign({options:input[1]||{},recordTypes:properties.recordTypes,errors:errors,keys:keys,message:message,Promise:promise.Promise},CustomAdapter[internalKey]?{transforms:properties.transforms}:null))}var Adapter=require("./"),errors=require("../common/errors"),keys=require("../common/keys"),message=require("../common/message"),assign=require("../common/assign"),constants=require("../common/constants"),internalKey=constants.internal,promise=require("../common/promise");module.exports=AdapterSingleton},{"../common/assign":17,"../common/constants":19,"../common/errors":21,"../common/keys":24,"../common/message":25,"../common/promise":27,"./":7}],9:[function(require,module,exports){"use strict";function Fortune(recordTypes,options){if(!(this instanceof Fortune))return new Fortune(recordTypes,options);if(void 0===options&&(options={}),!("adapter"in options)&&hasIndexedDB&&hasWebWorker&&hasBlob&&hasCreateObjectURL)try{globalObject.indexedDB.open("").onsuccess=function(event){event.target.result.close()},options.adapter=[indexedDB]}catch(error){console.warn("IndexedDB capabilities detected, but a connection can not be opened due to browser security."),console.error(error)}return"settings"in options||(options.settings={}),"enforceLinks"in options.settings||(options.settings.enforceLinks=!1),this.constructor(recordTypes,options)}var Core=require("./core"),promise=require("./common/promise"),assign=require("./common/assign"),getGlobalObject=require("./common/global_object"),memory=require("./adapter/adapters/memory"),indexedDB=require("./adapter/adapters/indexeddb"),request=require("./net/websocket_request"),sync=require("./net/websocket_sync"),adapters={memory:memory,indexedDB:indexedDB},net={request:request,sync:sync},globalObject=getGlobalObject(),hasIndexedDB="indexedDB"in globalObject,hasWebWorker="Worker"in globalObject,hasBlob="Blob"in globalObject,hasCreateObjectURL="URL"in globalObject&&"createObjectURL"in URL;Fortune.prototype=Object.create(Core.prototype),assign(Fortune,Core),Object.defineProperty(Fortune,"Promise",{enumerable:!0,get:function(){return promise.Promise},set:function(x){promise.Promise=x}}),assign(Fortune,{adapters:adapters,net:net}),module.exports=Fortune},{"./adapter/adapters/indexeddb":3,"./adapter/adapters/memory":6,"./common/assign":17,"./common/global_object":23,"./common/promise":27,"./core":29,"./net/websocket_request":41,"./net/websocket_sync":42}],10:[function(require,module,exports){"use strict";var pull=require("./array/pull");module.exports=function(record,update){var field;for(field in update.replace)record[field]=update.replace[field];for(field in update.push)record[field]=record[field]?record[field].concat(update.push[field]):[].concat(update.push[field]);for(field in update.pull)record[field]=record[field]?pull(record[field],update.pull[field]):[]}},{"./array/pull":14}],11:[function(require,module,exports){"use strict";module.exports=function(array,fn){var i,j,value,result;for(i=0,j=array.length;j>i;i++)if(value=array[i],result=fn(value))return value}},{}],12:[function(require,module,exports){"use strict";module.exports=function(array,value){var i,j;for(i=0,j=array.length;j>i;i++)if(array[i]===value)return!0;return!1}},{}],13:[function(require,module,exports){"use strict";module.exports=function(array,fn){var i,j,k=[],l=0;for(i=0,j=array.length;j>i;i++)k[l++]=fn(array[i],i,array);return k}},{}],14:[function(require,module,exports){"use strict";module.exports=function(array,values){var value,i,j,hash={},clone=[];if(Array.isArray(values))for(i=0,j=values.length;j>i;i++)hash[values[i]]=!0;else hash[values]=!0;for(i=array.length;i--;)value=array[i],value in hash||clone.push(value);return clone}},{}],15:[function(require,module,exports){"use strict";module.exports=function(array,fn,initialValue){var i,j,k=initialValue;for(i=0,j=array.length;j>i;i++)k=fn(k,array[i],i,array);return k}},{}],16:[function(require,module,exports){"use strict";module.exports=function(a){var i,j,k,seen={},result=[];for(i=0,j=a.length;j>i;i++)k=a[i],k in seen||(result.push(k),seen[k]=!0);return result}},{}],17:[function(require,module,exports){"use strict";module.exports=function(target){var i,j,key,source;for(i=1,j=arguments.length;j>i;i++){source=arguments[i];for(key in source)target[key]=source[key]}return target}},{}],18:[function(require,module,exports){"use strict";module.exports=function deepClone(node){var clone,key,value,isArray;if(Array.isArray(node))isArray=!0;else if(!node||Object.getPrototypeOf(node)!==Object.prototype)return node;clone=isArray?[]:{};for(key in node)value=node[key],clone[key]=value&&Object.getPrototypeOf(value)===Object.prototype||Array.isArray(value)?deepClone(value):value;return clone}},{}],19:[function(require,module,exports){"use strict";exports.primary="id",exports.type="type",exports.link="link",exports.inverse="inverse",exports.isArray="isArray",exports.denormalizedInverse="__denormalizedInverse",exports.internal="__internal",exports.change="change",exports.sync="sync",exports.connect="connect",exports.disconnect="disconnect",exports.failure="failure",exports.find="find",exports.create="create",exports.update="update",exports["delete"]="delete"},{}],20:[function(require,module,exports){(function(Buffer){"use strict";function deepEqual(a,b){var key,value,compare,aLength=0,bLength=0;if(a===b)return!0;if(!a||!b)return!1;if(a.prototype!==b.prototype)return!1;for(key in a)if(aLength++,value=a[key],compare=b[key],"object"!=typeof value){if(Buffer.isBuffer(value)){if(!Buffer.isBuffer(compare)||!value.equals(compare))return!1}else if(value&&"function"==typeof value.getTime){if(!compare||"function"!=typeof compare.getTime||value.getTime()!==compare.getTime())return!1}else if(value!==compare)return!1}else if("object"!=typeof compare||!deepEqual(value,compare))return!1;for(key in b)bLength++;return aLength===bLength}module.exports=deepEqual}).call(this,{isBuffer:require("../../node_modules/is-buffer/index.js")})},{"../../node_modules/is-buffer/index.js":53}],21:[function(require,module,exports){"use strict";var responseClass=require("./response_classes");exports.BadRequestError=responseClass.BadRequestError,exports.UnauthorizedError=responseClass.UnauthorizedError,exports.ForbiddenError=responseClass.ForbiddenError,exports.NotFoundError=responseClass.NotFoundError,exports.MethodError=responseClass.MethodError,exports.NotAcceptableError=responseClass.NotAcceptableError,exports.ConflictError=responseClass.ConflictError,exports.UnsupportedError=responseClass.UnsupportedError,exports.nativeErrors=responseClass.nativeErrors},{"./response_classes":28}],22:[function(require,module,exports){"use strict";var constants=require("./constants");exports.change=constants.change,exports.sync=constants.sync,exports.connect=constants.connect,exports.disconnect=constants.disconnect,exports.failure=constants.failure},{"./constants":19}],23:[function(require,module,exports){(function(global){"use strict";module.exports=function(){return"undefined"!=typeof self?self:"undefined"!=typeof global?global:Function("return this")()}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],24:[function(require,module,exports){"use strict";var constants=require("./constants");exports.primary=constants.primary,exports.type=constants.type,exports.link=constants.link,exports.isArray=constants.isArray,exports.inverse=constants.inverse,exports.denormalizedInverse=constants.denormalizedInverse},{"./constants":19}],25:[function(require,module,exports){"use strict";function message(id,language,data){var str,key;if(language&&language in message||(language="en"),!(id in message[language]))return message[language][genericMessage]||message.en[genericMessage];str=message[language][id];for(key in data)str=str.replace("{"+key+"}",data[key]);return str}var genericMessage="GenericError";module.exports=message,message.en={GenericError:"An internal error occurred.",MalformedRequest:"The request was malformed.",InvalidBody:"The request body is invalid.",SerializerNotFound:'The serializer for "{id}" does not exist.',InputOnly:"Input only.",InvalidID:"An ID is invalid.",DateISO8601:"Date string must be an ISO 8601 formatted string.",DateInvalid:"Date value is invalid.",BufferEncoding:"Buffer value must be a {bufferEncoding}-encoded string.",JSONParse:"Could not parse value as JSON.",MissingPayload:"Payload is missing.",SpecifiedIDs:"IDs should not be specified.",InvalidURL:"Invalid URL.",RelatedRecordNotFound:'A related record for the field "{field}" was not found.',CreateRecordsInvalid:"There are no valid records to be created.",CreateRecordsFail:"Records could not be created.",CreateRecordMissingID:"An ID on a created record is missing.",DeleteRecordsInvalid:"There are no records to be deleted.",UnspecifiedType:"The type is unspecified.",InvalidType:'The requested type "{type}" is not a valid type.',InvalidMethod:'The method "{method}" is unrecognized.',CollisionToOne:'Multiple records can not have the same to-one link value on the field "{field}".',CollisionDuplicate:'Duplicate ID "{id}" in the field "{field}".',UpdateRecordMissing:"The record to be updated could not be found.",UpdateRecordsInvalid:"There are no valid updates.",UpdateRecordMissingID:"An ID on an update is missing.",EnforceArrayType:'The value of "{key}" is invalid, it must be an array with values of type "{type}".',EnforceArray:'The value of "{key}" is invalid, it must be an array.',EnforceSameID:'An ID of "{key}" is invalid, it cannot be the same ID of the record.',EnforceSingular:'The value of "{key}" can not be an array, it must be a singular value.',EnforceValue:'The value of "{key}" is invalid, it must be a "{type}".',EnforceValueArray:'A value in the array of "{key}" is invalid, it must be a "{type}".',FieldsFormat:"Fields format is invalid. It may either be inclusive or exclusive, but not both.",RecordExists:'A record with ID "{id}" already exists.',Index:"Index",Type:"Type",Include:"Include",QueryOptions:"Query Options",IncludedLabel:"included",NoResults:"No results.",Create:"Create",Update:"Update",Delete:"Delete",True:"True",False:"False",IncludePath:"Path (dot-separated)",Query:"Query",Fields:"Fields",Match:"Match",Sort:"Sort",Field:"Field",Pagination:"Pagination",Limit:"Limit",Offset:"Offset"}},{}],26:[function(require,module,exports){
"use strict";var constants=require("./constants");exports.find=constants.find,exports.create=constants.create,exports.update=constants.update,exports["delete"]=constants["delete"]},{"./constants":19}],27:[function(require,module,exports){"use strict";exports.Promise=Promise},{}],28:[function(require,module,exports){"use strict";function successClass(name){return Function("assign","return function "+name+" (x) { assign(this, x) }")(assign)}var errorClass=require("error-class"),assign=require("./assign");exports.OK=successClass("OK"),exports.Created=successClass("Created"),exports.Empty=successClass("Empty"),exports.BadRequestError=errorClass("BadRequestError"),exports.UnauthorizedError=errorClass("UnauthorizedError"),exports.ForbiddenError=errorClass("ForbiddenError"),exports.NotFoundError=errorClass("NotFoundError"),exports.MethodError=errorClass("MethodError"),exports.NotAcceptableError=errorClass("NotAcceptableError"),exports.ConflictError=errorClass("ConflictError"),exports.UnsupportedError=errorClass("UnsupportedError"),exports.nativeErrors=[Error,TypeError,ReferenceError,RangeError,SyntaxError,EvalError,URIError]},{"./assign":17,"error-class":49}],29:[function(require,module,exports){"use strict";function Fortune(options){this.constructor(options)}function bindMiddleware(scope,method){return function(x){return method.call(scope,x)}}var EventLite=require("event-lite"),memoryAdapter=require("./adapter/adapters/memory"),AdapterSingleton=require("./adapter/singleton"),assign=require("./common/assign"),validate=require("./record_type/validate"),ensureTypes=require("./record_type/ensure_types"),dispatch=require("./dispatch"),promise=require("./common/promise"),middlewares=dispatch.middlewares,Adapter=require("./adapter"),errors=require("./common/errors"),methods=require("./common/methods"),events=require("./common/events"),message=require("./common/message");Fortune.prototype=Object.create(EventLite.prototype),Fortune.prototype.constructor=function(recordTypes,options){var adapter,method,stack,flows,type,transforms,i,j,self=this;if("object"!=typeof recordTypes)throw new TypeError("First argument must be an object.");if(!Object.keys(recordTypes).length)throw new Error("At least one type must be specified.");"adapter"in options||(options.adapter=[memoryAdapter]),"settings"in options||(options.settings={}),"transforms"in options||(options.transforms={}),"enforceLinks"in options.settings||(options.settings.enforceLinks=!0),flows={};for(method in methods){for(stack=[middlewares[method],middlewares.include,middlewares.end],i=0,j=stack.length;j>i;i++)stack[i]=bindMiddleware(self,stack[i]);flows[methods[method]]=stack}transforms=options.transforms;for(type in transforms){if(!(type in recordTypes))throw new Error('Attempted to define transform on "'+type+'" type which does not exist.');if(!Array.isArray(transforms[type]))throw new TypeError('Transform value for "'+type+'" type must be an array.')}for(type in recordTypes)validate(recordTypes[type]),type in transforms||(transforms[type]=[]);adapter=new AdapterSingleton({adapter:options.adapter,recordTypes:recordTypes,transforms:transforms}),Object.defineProperties(self,{connectionStatus:{value:0,writable:!0},options:{value:options},transforms:{value:transforms},recordTypes:{value:recordTypes},adapter:{value:adapter},flows:{value:flows}})},Fortune.prototype.request=function(options){var self=this,Promise=promise.Promise,connectionStatus=self.connectionStatus;return 0===connectionStatus?self.connect().then(function(){return dispatch(self,options)}):1===connectionStatus?new Promise(function(resolve,reject){self.once(events.failure,function(){reject(new Error("Connection failed."))}),self.once(events.connect,function(){resolve(dispatch(self,options))})}):dispatch(self,options)},Fortune.prototype.connect=function(){var self=this,Promise=promise.Promise;return 1===self.connectionStatus?Promise.reject(new Error("Connection is in progress.")):2===self.connectionStatus?Promise.reject(new Error("Connection is already done.")):(self.connectionStatus=1,new Promise(function(resolve,reject){ensureTypes(self.recordTypes),self.adapter.connect().then(function(){return self.connectionStatus=2,self.emit(events.connect),resolve(self)},function(error){return self.connectionStatus=0,self.emit(events.failure),reject(error)})}))},Fortune.prototype.disconnect=function(){var self=this,Promise=promise.Promise;return 2!==self.connectionStatus?Promise.reject(new Error("Instance has not been connected.")):(self.connectionStatus=1,new Promise(function(resolve,reject){return self.adapter.disconnect().then(function(){return self.connectionStatus=0,self.emit(events.disconnect),resolve(self)},function(error){return self.connectionStatus=2,self.emit(events.failure),reject(error)})}))},assign(Fortune,{Adapter:Adapter,errors:errors,methods:methods,message:message,events:events}),module.exports=Fortune},{"./adapter":7,"./adapter/adapters/memory":6,"./adapter/singleton":8,"./common/assign":17,"./common/errors":21,"./common/events":22,"./common/message":25,"./common/methods":26,"./common/promise":27,"./dispatch":36,"./record_type/ensure_types":44,"./record_type/validate":45,"event-lite":50}],30:[function(require,module,exports){"use strict";var message=require("../common/message"),promise=require("../common/promise"),unique=require("../common/array/unique"),map=require("../common/array/map"),includes=require("../common/array/includes"),errors=require("../common/errors"),BadRequestError=errors.BadRequestError,keys=require("../common/keys"),primaryKey=keys.primary,linkKey=keys.link,isArrayKey=keys.isArray,inverseKey=keys.inverse;module.exports=function(record,fields,links,meta){var Promise=promise.Promise,adapter=this.adapter,enforceLinks=this.options.settings.enforceLinks;return Promise.all(map(links,function(field){var ids=Array.isArray(record[field])?record[field]:field in record&&null!==record[field]?[record[field]]:[],fieldLink=fields[field][linkKey],fieldInverse=fields[field][inverseKey],findOptions={fields:{}};return findOptions.fields[fieldInverse]=!0,new Promise(function(resolve,reject){return ids.length?adapter.find(fieldLink,ids,findOptions,meta).then(function(records){var recordIds,i,j;if(enforceLinks)for(recordIds=unique(map(records,function(record){return record[primaryKey]})),i=0,j=ids.length;j>i;i++)if(!includes(recordIds,ids[i]))return reject(new BadRequestError(message("RelatedRecordNotFound",meta.language,{field:field})));return resolve(records)}):resolve()})})).then(function(partialRecords){var records,i,j,object={};for(i=0,j=partialRecords.length;j>i;i++)records=partialRecords[i],records&&(object[links[i]]=fields[links[i]][isArrayKey]?records:records[0]);return object})}},{"../common/array/includes":12,"../common/array/map":13,"../common/array/unique":16,"../common/errors":21,"../common/keys":24,"../common/message":25,"../common/promise":27}],31:[function(require,module,exports){"use strict";var validateRecords=require("./validate_records"),checkLinks=require("./check_links"),enforce=require("../record_type/enforce"),message=require("../common/message"),promise=require("../common/promise"),map=require("../common/array/map"),errors=require("../common/errors"),BadRequestError=errors.BadRequestError,updateHelpers=require("./update_helpers"),getUpdate=updateHelpers.getUpdate,addId=updateHelpers.addId,constants=require("../common/constants"),changeEvent=constants.change,createMethod=constants.create,updateMethod=constants.update,primaryKey=constants.primary,linkKey=constants.link,inverseKey=constants.inverse,isArrayKey=constants.isArray,denormalizedInverseKey=constants.denormalizedInverse;module.exports=function(context){var transaction,records,type,meta,transform,fields,language,self=this,Promise=promise.Promise,adapter=self.adapter,recordTypes=self.recordTypes,transforms=self.transforms,updates={},links=[];return Promise.resolve(context.request.payload).then(function(payload){var i,j,field;if(records=payload,!records||!records.length)throw new BadRequestError(message("CreateRecordsInvalid",language));type=context.request.type,meta=context.request.meta,language=meta.language,transform=transforms[type],fields=recordTypes[type];for(field in fields)if(linkKey in fields[field]&&links.push(field),denormalizedInverseKey in fields[field])for(i=0,j=records.length;j>i;i++)delete records[i][field];return adapter.beginTransaction()}).then(function(result){return context.transaction=transaction=result,"function"==typeof transform[0]?Promise.all(map(records,function(record){return transform[0](context,record)})):records}).then(function(results){return records=results,Promise.all(map(records,function(record){return enforce(type,record,fields,meta),checkLinks.call(self,record,fields,links,meta).then(function(){return record})}))}).then(function(records){return validateRecords.call(self,records,fields,links,meta),transaction.create(type,records,meta)}).then(function(createdRecords){var i,j,k,l,m,n,record,field,inverseField,linkedType,linkedIsArray,linkedIds,id,idCache={};if(records=createdRecords,Object.defineProperty(context.response,"records",{configurable:!0,value:records}),!records.length)throw new BadRequestError(message("CreateRecordsFail",language));for(i=0,j=records.length;j>i;i++){if(record=records[i],!(primaryKey in record))throw new Error(message("CreateRecordMissingID",language));for(k=0,l=links.length;l>k;k++)if(field=links[k],inverseField=fields[field][inverseKey],field in record&&inverseField)for(linkedType=fields[field][linkKey],linkedIsArray=recordTypes[linkedType][inverseField][isArrayKey],linkedIds=Array.isArray(record[field])?record[field]:[record[field]],updates[linkedType]||(updates[linkedType]=[]),idCache[linkedType]||(idCache[linkedType]={}),m=0,n=linkedIds.length;n>m;m++)id=linkedIds[m],null!==id&&addId(record[primaryKey],getUpdate(linkedType,id,updates,idCache),inverseField,linkedIsArray)}return Promise.all(map(Object.keys(updates),function(type){return updates[type].length?transaction.update(type,updates[type],meta):null}))}).then(function(){return transaction.endTransaction()})["catch"](function(error){throw transaction&&transaction.endTransaction(error),error}).then(function(){var currentType,eventData={};eventData[createMethod]={},eventData[createMethod][type]=records;for(currentType in updates)updates[currentType].length&&(updateMethod in eventData||(eventData[updateMethod]={}),eventData[updateMethod][currentType]=updates[currentType]);return self.emit(changeEvent,eventData),context})}},{"../common/array/map":13,"../common/constants":19,"../common/errors":21,"../common/message":25,"../common/promise":27,"../record_type/enforce":43,"./check_links":30,"./update_helpers":38,"./validate_records":39}],32:[function(require,module,exports){"use strict";var message=require("../common/message"),promise=require("../common/promise"),map=require("../common/array/map"),errors=require("../common/errors"),NotFoundError=errors.NotFoundError,updateHelpers=require("./update_helpers"),getUpdate=updateHelpers.getUpdate,removeId=updateHelpers.removeId,constants=require("../common/constants"),changeEvent=constants.change,deleteMethod=constants["delete"],updateMethod=constants.update,primaryKey=constants.primary,linkKey=constants.link,inverseKey=constants.inverse,isArrayKey=constants.isArray;module.exports=function(context){var transaction,field,records,self=this,Promise=promise.Promise,request=context.request,type=request.type,ids=request.ids,meta=request.meta,language=meta.language,adapter=self.adapter,recordTypes=self.recordTypes,transforms=self.transforms,updates={},fields=recordTypes[type],transform=transforms[type],links=[];for(field in fields)linkKey in fields[field]&&links.push(field);return(ids?adapter.find(type,ids,null,meta):Promise.resolve()).then(function(foundRecords){if(records=foundRecords,ids){if(!records.length)throw new NotFoundError(message("DeleteRecordsInvalid",language));Object.defineProperty(context.response,"records",{configurable:!0,value:records})}return adapter.beginTransaction()}).then(function(result){return context.transaction=transaction=result,"function"==typeof transform[0]?Promise.all(map(records,function(record){return transform[0](context,record)})):records}).then(function(){return transaction["delete"](type,ids,meta)}).then(function(count){var i,j,k,l,m,n,record,field,id,inverseField,linkedType,linkedIsArray,linkedIds,idCache={};for(ids||(records=[],records.count=count,Object.defineProperty(context.response,"records",{configurable:!0,value:records})),i=0,j=records.length;j>i;i++)for(record=records[i],k=0,l=links.length;l>k;k++)if(field=links[k],inverseField=fields[field][inverseKey],field in record&&inverseField)for(linkedType=fields[field][linkKey],linkedIsArray=recordTypes[linkedType][inverseField][isArrayKey],linkedIds=Array.isArray(record[field])?record[field]:[record[field]],updates[linkedType]||(updates[linkedType]=[]),idCache[linkedType]||(idCache[linkedType]={}),m=0,n=linkedIds.length;n>m;m++)id=linkedIds[m],null!==id&&removeId(record[primaryKey],getUpdate(linkedType,id,updates,idCache),inverseField,linkedIsArray);return Promise.all(map(Object.keys(updates),function(type){return updates[type].length?transaction.update(type,updates[type],meta):null}))}).then(function(){return transaction.endTransaction()})["catch"](function(error){throw transaction&&transaction.endTransaction(error),error}).then(function(){var currentType,eventData={};eventData[deleteMethod]={},eventData[deleteMethod][type]=ids;for(currentType in updates)updates[currentType].length&&(updateMethod in eventData||(eventData[updateMethod]={}),eventData[updateMethod][currentType]=updates[currentType]);return self.emit(changeEvent,eventData),context})}},{"../common/array/map":13,"../common/constants":19,"../common/errors":21,"../common/message":25,"../common/promise":27,"./update_helpers":38}],33:[function(require,module,exports){"use strict";var map=require("../common/array/map"),promise=require("../common/promise");module.exports=function(context){var Promise=promise.Promise,transforms=this.transforms,request=context.request,response=context.response,type=request.type,transform=transforms[type],records=response.records,include=response.include;return delete response.records,delete response.include,delete context.transaction,(records?Promise.all(map(records,function(record){return Promise.resolve("function"==typeof transform[1]?transform[1](context,record):record)})).then(function(updatedRecords){var includeTypes,i,j;for(i=0,j=updatedRecords.length;j>i;i++)records[i]=updatedRecords[i];return include?(includeTypes=Object.keys(include),Promise.all(map(includeTypes,function(includeType){return Promise.all(map(include[includeType],function(record){return Promise.resolve("function"==typeof transforms[includeType][1]?transforms[includeType][1](context,record):record)}))})).then(function(types){var i,j,include={};for(i=0,j=types.length;j>i;i++)include[includeTypes[i]]=types[i];return include})):void 0}):Promise.resolve()).then(function(include){return context.response.payload={records:records},include&&(context.response.payload.include=include),records&&"count"in records&&(context.response.payload.count=records.count),context})}},{"../common/array/map":13,"../common/promise":27}],34:[function(require,module,exports){"use strict";module.exports=function(context){var adapter=this.adapter,request=context.request,type=request.type,ids=request.ids,options=request.options,meta=request.meta;return type?adapter.find(type,ids,options,meta).then(function(records){return Object.defineProperty(context.response,"records",{configurable:!0,value:records}),context}):context}},{}],35:[function(require,module,exports){"use strict";function matchId(id){return function(record){return record[primaryKey]===id}}var promise=require("../common/promise"),map=require("../common/array/map"),find=require("../common/array/find"),reduce=require("../common/array/reduce"),errors=require("../common/errors"),BadRequestError=errors.BadRequestError,keys=require("../common/keys"),primaryKey=keys.primary,linkKey=keys.link;module.exports=function include(context){var i,j,record,id,Promise=promise.Promise,request=context.request,type=request.type,ids=request.ids||[],include=request.include,meta=request.meta,response=context.response,records=response.records,recordTypes=this.recordTypes,adapter=this.adapter,idCache={};for(idCache[type]={},i=0,j=ids.length;j>i;i++)idCache[type][ids[i]]=!0;if(!type||!include||!records)return context;if(ids&&!ids.length)for(i=0,j=records.length;j>i;i++)record=records[i],id=record[primaryKey],idCache[type][id]||(idCache[type][id]=!0);return Promise.all(map(include,function(fields){return new Promise(function(resolve,reject){var currentCache,currentOptions,currentField,includeOptions,currentType=type,currentIds=[];return"object"==typeof fields[fields.length-1]&&(includeOptions=fields[fields.length-1],fields=fields.slice(0,-1)),Promise.all(map(records,function(record){var options;return fields[0]in record?record:(options={fields:{}},options.fields[fields[0]]=!0,adapter.find(type,[record[primaryKey]],options,meta).then(function(records){return records[0]}))})).then(function(records){return reduce(fields,function(records,field,index){return records.then(function(cursor){if(currentField=recordTypes[currentType][field],!currentType||!currentField)return[];if(!(linkKey in currentField))throw new BadRequestError('The field "'+field+'" does not define a link.');return currentCache={},currentType=currentField[linkKey],currentIds=reduce(cursor,function(ids,record){var i,j,id,linkedIds=Array.isArray(record[field])?record[field]:[record[field]];for(i=0,j=linkedIds.length;j>i;i++)id=linkedIds[i],id&&!currentCache[id]&&(currentCache[id]=!0,ids.push(id));return ids},[]),index===fields.length-1?currentOptions=includeOptions:(currentOptions={fields:{}},currentOptions.fields[fields[index+1]]=!0),currentIds.length?adapter.find(currentType,currentIds,currentOptions,meta):[]})},Promise.resolve(records))}).then(function(records){return resolve({type:currentType,ids:currentIds,records:records})},function(error){return reject(error)})})})).then(function(containers){var include=reduce(containers,function(include,container){var i,j,id,record;if(!container.ids.length)return include;for(include[container.type]||(include[container.type]=[]),idCache[container.type]||(idCache[container.type]={}),i=0,j=container.ids.length;j>i;i++)id=container.ids[i],idCache[container.type][id]||(record=find(container.records,matchId(id)),record&&(idCache[container.type][id]=!0,include[container.type].push(record)));return include[container.type].length||delete include[container.type],include},{});return Object.keys(include).length&&Object.defineProperty(context.response,"include",{configurable:!0,value:include}),context})}},{"../common/array/find":11,"../common/array/map":13,"../common/array/reduce":15,"../common/errors":21,"../common/keys":24,"../common/promise":27}],36:[function(require,module,exports){"use strict";function dispatch(scope,options){var flows=scope.flows,recordTypes=scope.recordTypes,Promise=promise.Promise,context=setDefaults(options);return Promise.resolve(context).then(function(context){var chain,flow,error,i,j,method=context.request.method,type=context.request.type,ids=context.request.ids,language=context.request.meta.language;if(language=context.request.meta.language,ids&&(context.request.ids=unique(ids)),null===type)throw error=new BadRequestError(message("UnspecifiedType",language)),error.isTypeUnspecified=!0,error;if(!(type in recordTypes))throw new NotFoundError(message("InvalidType",language,{type:type}));if(!(method in flows))throw new MethodError(message("InvalidMethod",language,{method:method}));for(chain=Promise.resolve(context),flow=flows[method],i=0,j=flow.length;j>i;i++)chain=chain.then(flow[i]);return chain}).then(function(context){var method=context.request.method,response=context.response,payload=response.payload;return payload?method===createMethod?new Created(response):new OK(response):new Empty(response)})["catch"](function(error){throw assign(error,context.response)})}function setDefaults(options){var context={request:{method:findMethod,type:null,ids:null,options:{},include:[],meta:{},payload:null},response:{meta:{},payload:null}};return assign(context.request,options),context}var promise=require("../common/promise"),assign=require("../common/assign"),unique=require("../common/array/unique"),message=require("../common/message"),responseClass=require("../common/response_classes"),BadRequestError=responseClass.BadRequestError,NotFoundError=responseClass.NotFoundError,MethodError=responseClass.MethodError,OK=responseClass.OK,Empty=responseClass.Empty,Created=responseClass.Created,methods=require("../common/methods"),findMethod=methods.find,createMethod=methods.create;dispatch.middlewares={create:require("./create"),"delete":require("./delete"),update:require("./update"),find:require("./find"),include:require("./include"),end:require("./end")},module.exports=dispatch},{"../common/array/unique":16,"../common/assign":17,"../common/message":25,"../common/methods":26,"../common/promise":27,"../common/response_classes":28,"./create":31,"./delete":32,"./end":33,"./find":34,"./include":35,"./update":37}],37:[function(require,module,exports){"use strict";function validateUpdates(updates,meta){var i,j,update,language=meta.language;if(!updates||!updates.length)throw new BadRequestError(message("UpdateRecordsInvalid",language));for(i=0,j=updates.length;j>i;i++)if(update=updates[i],!update[primaryKey])throw new BadRequestError(message("UpdateRecordMissingID",language))}function dropFields(update,fields){var field;for(field in update.replace)field in fields||delete update.replace[field];for(field in update.pull)field in fields||delete update.pull[field];for(field in update.push)field in fields||delete update.push[field]}var deepEqual=require("../common/deep_equal"),assign=require("../common/assign"),clone=require("../common/clone"),validateRecords=require("./validate_records"),checkLinks=require("./check_links"),enforce=require("../record_type/enforce"),message=require("../common/message"),promise=require("../common/promise"),applyUpdate=require("../common/apply_update"),updateHelpers=require("./update_helpers"),getUpdate=updateHelpers.getUpdate,addId=updateHelpers.addId,removeId=updateHelpers.removeId,errors=require("../common/errors"),NotFoundError=errors.NotFoundError,BadRequestError=errors.BadRequestError,find=require("../common/array/find"),includes=require("../common/array/includes"),map=require("../common/array/map"),constants=require("../common/constants"),changeEvent=constants.change,updateMethod=constants.update,primaryKey=constants.primary,linkKey=constants.link,inverseKey=constants.inverse,isArrayKey=constants.isArray,denormalizedInverseKey=constants.denormalizedInverse;module.exports=function(context){var transaction,updates,fields,transform,type,meta,language,self=this,Promise=promise.Promise,adapter=self.adapter,recordTypes=self.recordTypes,transforms=self.transforms,updateMap=new WeakMap,linkedMap=new WeakMap,relatedUpdates={},transformedUpdates=[],links=[];return Promise.resolve(context.request.payload).then(function(payload){var i,j,update,field;updates=payload,validateUpdates(updates,context.request.meta),type=context.request.type,meta=context.request.meta,language=meta.language,fields=recordTypes[type],transform=transforms[type];for(field in fields)if(linkKey in fields[field]&&links.push(field),denormalizedInverseKey in fields[field])for(i=0,j=updates.length;j>i;i++)update=updates[i],update.replace&&delete update.replace[field],update.pull&&delete update.pull[field],update.push&&delete update.push[field];return adapter.beginTransaction()}).then(function(result){return context.transaction=transaction=result,adapter.find(type,map(updates,function(update){return update[primaryKey]}),null,meta)}).then(function(records){return Promise.all(map(records,function(record){var update,cloneUpdate,hasTransform="function"==typeof transform[0],id=record[primaryKey];if(update=find(updates,function(update){return update[primaryKey]===id}),!update)throw new NotFoundError(message("UpdateRecordMissing",language));return hasTransform&&(cloneUpdate=clone(update)),Promise.resolve(hasTransform?transform[0](context,record,update):update).then(function(update){if(hasTransform&&(deepEqual(update,cloneUpdate)||(context.response.meta.updateModified=!0),update[primaryKey]!==id))throw new BadRequestError(message("InvalidID",language));return transformedUpdates.push(update),updateMap.set(update,record),record=assign({},record),applyUpdate(record,update),update.operate&&(record=adapter.applyOperators(record,update.operate)),enforce(type,record,fields,meta),checkLinks.call(self,record,fields,links,meta).then(function(linked){return linkedMap.set(update,linked),record})})}))}).then(function(records){var i,j;for(validateRecords.call(self,records,fields,links,meta),Object.defineProperty(context.response,"records",{configurable:!0,value:records}),i=0,j=transformedUpdates.length;j>i;i++)dropFields(transformedUpdates[i],fields);return transaction.update(type,transformedUpdates,meta)}).then(function(){var inverseField,isArray,linkedType,linkedIsArray,linked,record,partialRecord,partialRecords,ids,id,push,pull,update,field,i,j,k,l,m,n,idCache={};for(i=0,j=transformedUpdates.length;j>i;i++)for(update=transformedUpdates[i],k=0,l=links.length;l>k;k++)if(field=links[k],inverseField=fields[field][inverseKey]){if(isArray=fields[field][isArrayKey],linkedType=fields[field][linkKey],linkedIsArray=recordTypes[linkedType][inverseField][isArrayKey],relatedUpdates[linkedType]||(relatedUpdates[linkedType]=[]),idCache[linkedType]||(idCache[linkedType]={}),record=updateMap.get(update),linked=linkedMap.get(update),update.replace&&field in update.replace){if(id=update.replace[field],!Array.isArray(id)){if(id===record[field])continue;null!==id&&addId(update[primaryKey],getUpdate(linkedType,id,relatedUpdates,idCache),inverseField,linkedIsArray),field in linked&&null!==linked[field][inverseField]&&!linkedIsArray&&linked[field][inverseField]!==update[primaryKey]&&removeId(id,getUpdate(linkedType,linked[field][inverseField],relatedUpdates,idCache),inverseField,linkedIsArray),null!==record[field]&&record[field]!==update[field]&&record[field]!==id&&removeId(update[primaryKey],getUpdate(linkedType,record[field],relatedUpdates,idCache),inverseField,linkedIsArray);continue}for(ids=id,m=0,n=record[field].length;n>m;m++)if(id=record[field][m],!includes(ids,id)){if("pull"in update||(update.pull={}),field in update.pull){if(Array.isArray(update.pull[field])){update.pull[field].push(id);continue}update.pull[field]=[update.pull[field],id];continue}update.pull[field]=[id]}for(m=0,n=ids.length;n>m;m++)if(id=ids[m],!includes(record[field],id)){if("push"in update||(update.push={}),field in update.push){if(Array.isArray(update.push[field])){update.push[field].push(id);continue}update.push[field]=[update.push[field],id];continue}update.push[field]=[id]}delete update.replace[field]}if(update.pull&&update.pull[field])for(pull=Array.isArray(update.pull[field])?update.pull[field]:[update.pull[field]],m=0,n=pull.length;n>m;m++)id=pull[m],null!==id&&removeId(update[primaryKey],getUpdate(linkedType,id,relatedUpdates,idCache),inverseField,linkedIsArray);if(update.push&&update.push[field])for(push=Array.isArray(update.push[field])?update.push[field]:[update.push[field]],m=0,n=push.length;n>m;m++)id=push[m],null!==id&&addId(update[primaryKey],getUpdate(linkedType,id,relatedUpdates,idCache),inverseField,linkedIsArray);if(field in linked&&!linkedIsArray)for(partialRecords=Array.isArray(linked[field])?linked[field]:[linked[field]],m=0,n=partialRecords.length;n>m;m++)partialRecord=partialRecords[m],partialRecord[inverseField]!==update[primaryKey]&&removeId(partialRecord[primaryKey],getUpdate(type,partialRecord[inverseField],relatedUpdates,idCache),field,isArray)}return Promise.all(map(Object.keys(relatedUpdates),function(type){return relatedUpdates[type].length?transaction.update(type,relatedUpdates[type],meta):null}))}).then(function(){return transaction.endTransaction()})["catch"](function(error){throw transaction&&transaction.endTransaction(error),error}).then(function(){var linkedType,eventData={};eventData[updateMethod]={},eventData[updateMethod][type]=transformedUpdates;for(linkedType in relatedUpdates)relatedUpdates[linkedType].length&&(linkedType!==type?eventData[updateMethod][linkedType]=relatedUpdates[linkedType]:eventData[updateMethod][type]=eventData[updateMethod][type].concat(relatedUpdates[type]));return self.emit(changeEvent,eventData),context})}},{"../common/apply_update":10,"../common/array/find":11,"../common/array/includes":12,"../common/array/map":13,"../common/assign":17,"../common/clone":18,"../common/constants":19,"../common/deep_equal":20,"../common/errors":21,"../common/message":25,"../common/promise":27,"../record_type/enforce":43,"./check_links":30,"./update_helpers":38,"./validate_records":39}],38:[function(require,module,exports){"use strict";var find=require("../common/array/find"),keys=require("../common/keys"),primaryKey=keys.primary;exports.getUpdate=function(type,id,updates,cache){var update;return cache[type]&&cache[type][id]?find(updates[type],function(update){return update[primaryKey]===id}):(update={id:id},updates[type]||(updates[type]=[]),updates[type].push(update),cache[type]={},cache[type][id]=!0,update)},exports.addId=function(id,update,field,isArray){return isArray?(update.push||(update.push={}),update.push[field]||(update.push[field]=[]),void update.push[field].push(id)):(update.replace||(update.replace={}),void(update.replace[field]=id))},exports.removeId=function(id,update,field,isArray){return isArray?(update.pull||(update.pull={}),update.pull[field]||(update.pull[field]=[]),void update.pull[field].push(id)):(update.replace||(update.replace={}),void(update.replace[field]=null))}},{"../common/array/find":11,"../common/keys":24}],39:[function(require,module,exports){"use strict";var message=require("../common/message"),errors=require("../common/errors"),ConflictError=errors.ConflictError,keys=require("../common/keys"),linkKey=keys.link,isArrayKey=keys.isArray,inverseKey=keys.inverse;module.exports=function(records,fields,links,meta){var i,j,k,l,m,n,value,field,record,id,ids,seen,fieldLink,fieldInverse,fieldIsArray,inverseIsArray,recordTypes=this.recordTypes,language=meta.language,toOneMap={};for(i=0,j=links.length;j>i;i++){if(field=links[i],fieldLink=fields[field][linkKey],fieldInverse=fields[field][inverseKey],fieldIsArray=fields[field][isArrayKey],inverseIsArray=recordTypes[fieldLink][fieldInverse][isArrayKey],fieldIsArray)for(k=0,l=records.length;l>k;k++)if(record=records[k],Array.isArray(record[field]))for(ids=record[field],seen={},m=0,n=ids.length;n>m;m++){if(id=ids[m],id in seen)throw new ConflictError(message("CollisionDuplicate",language,{id:id,field:field}));seen[id]=!0}if(!inverseIsArray)for(toOneMap[field]={},k=0,l=records.length;l>k;k++)for(record=records[k],value=record[field],ids=Array.isArray(value)?value:value?[value]:[],m=0,n=ids.length;n>m;m++){if(id=ids[m],id in toOneMap[field])throw new ConflictError(message("CollisionToOne",language,{field:field}));toOneMap[field][id]=!0}}}},{"../common/errors":21,"../common/keys":24,"../common/message":25}],40:[function(require,module,exports){"use strict";window.fortune=require("./browser")},{"./browser":9}],41:[function(require,module,exports){"use strict";function request(client,options,state){var Promise=promise.Promise,id=generateId(),data={id:id};if(options&&state)throw new Error("Must specify only options or state.");if(options)data.request=options;else{if(!state)throw new Error("Missing argument options or state.");data.state=state}return new Promise(function(resolve,reject){function listener(event){var data;if("decoded"in event)data=event.decoded;else try{data=event.decoded=msgpack.decode(new Uint8Array(event.data));
}catch(error){return reject(error)}return data.id!==id?null:(client.removeEventListener("message",listener),"error"in data?reject(new Error(data.error||"No error specified.")):resolve(data))}client.binaryType="arraybuffer",client.addEventListener("message",listener),client.send(msgpack.encode(data))})}var msgpack=require("msgpack-lite"),promise=require("../common/promise"),common=require("../adapter/adapters/common"),generateId=common.generateId;module.exports=request},{"../adapter/adapters/common":1,"../common/promise":27,"msgpack-lite":54}],42:[function(require,module,exports){"use strict";function sync(client,instance,merge){function syncListener(event){var data,changes,method,type,promises=[];if("decoded"in event)data=event.decoded;else try{data=event.decoded=msgpack.decode(new Uint8Array(event.data))}catch(error){return instance.emit(failureEvent,error)}if(!("changes"in data))return null;changes=void 0===merge?data.changes:merge(data.changes);for(method in changes)for(type in changes[method])promises.push(instance.adapter[method](type,changes[method][type]));return Promise.all(promises).then(function(){instance.emit(syncEvent,changes)},function(error){instance.emit(failureEvent,error)})}var Promise=promise.Promise;if(!(instance instanceof Fortune))throw new TypeError("An instance of Fortune is required.");return client.binaryType="arraybuffer",client.addEventListener("message",syncListener),syncListener}var Fortune=require("../core"),promise=require("../common/promise"),msgpack=require("msgpack-lite"),constants=require("../common/constants"),syncEvent=constants.sync,failureEvent=constants.failure;module.exports=sync},{"../common/constants":19,"../common/promise":27,"../core":29,"msgpack-lite":54}],43:[function(require,module,exports){(function(Buffer){"use strict";function checkValue(field,key,value,meta){var check,language=meta.language;if(null!==value&&(check=find(checkInput,function(pair){return pair[0]===field[typeKey]}),check=check?check[1]:field[typeKey],!check(value)))throw new BadRequestError(message(field[isArrayKey]?"EnforceValueArray":"EnforceValue",language,{key:key,type:field[typeKey].name}))}function matchId(a){return function(b){return a===b}}var message=require("../common/message"),find=require("../common/array/find"),errors=require("../common/errors"),BadRequestError=errors.BadRequestError,keys=require("../common/keys"),primaryKey=keys.primary,typeKey=keys.type,linkKey=keys.link,isArrayKey=keys.isArray,checkInput=[[String,function(value){return"string"==typeof value}],[Number,function(value){return"number"==typeof value}],[Boolean,function(value){return"boolean"==typeof value}],[Date,function(value){return value&&"function"==typeof value.getTime&&!Number.isNaN(value.getTime())}],[Object,function(value){return null!==value&&"object"==typeof value}],[Buffer,function(value){return Buffer.isBuffer(value)}]];module.exports=function(type,record,fields,meta){var i,j,key,value,fieldDefinition,language;meta||(meta={}),language=meta.language;for(key in record)if(fieldDefinition=fields[key])if(value=record[key],fieldDefinition[typeKey])if(fieldDefinition[isArrayKey]){if(!Array.isArray(value))throw new BadRequestError(message("EnforceArrayType",language,{key:key,type:fieldDefinition[typeKey].name}));for(i=0,j=value.length;j>i;i++)checkValue(fieldDefinition,key,value[i],meta)}else checkValue(fieldDefinition,key,value,meta);else if(fieldDefinition[linkKey]){if(fieldDefinition[isArrayKey]){if(!Array.isArray(value))throw new BadRequestError(message("EnforceArray",language,{key:key}));if(type===fieldDefinition[linkKey]&&find(value,matchId(record[primaryKey])))throw new BadRequestError(message("EnforceSameID",language,{key:key}));continue}if(Array.isArray(value))throw new BadRequestError(message("EnforceSingular",language,{key:key}));if(type===fieldDefinition[linkKey]&&record[primaryKey]===value)throw new BadRequestError(message("EnforceSameID",language,{key:key}))}else;else key!==primaryKey&&delete record[key];return record}}).call(this,require("buffer").Buffer)},{"../common/array/find":11,"../common/errors":21,"../common/keys":24,"../common/message":25,buffer:47}],44:[function(require,module,exports){"use strict";var keys=require("../common/keys"),linkKey=keys.link,inverseKey=keys.inverse,isArrayKey=keys.isArray,denormalizedInverseKey=keys.denormalizedInverse,denormalizedPrefix="__",denormalizedDelimiter="_",denormalizedPostfix="_inverse";module.exports=function(types){var type,field,definition,linkedFields,denormalizedField,denormalizedDefinition;for(type in types)for(field in types[type])if(definition=types[type][field],linkKey in definition){if(!(definition[linkKey]in types))throw new Error('The value for "'+linkKey+'" on "'+field+'" in type "'+type+'" is invalid, the record type does not exist.');if(linkedFields=types[definition[linkKey]],inverseKey in definition){if(!(definition[inverseKey]in linkedFields))throw new Error('The value for "'+inverseKey+'" on "'+field+'" in type "'+type+'" is invalid, the field does not exist.');if(linkedFields[definition[inverseKey]][inverseKey]!==field)throw new Error('The value for "'+inverseKey+'" on "'+field+'" in type "'+type+'" is invalid, the inversely related field must define its inverse as "'+field+'".');if(linkedFields[definition[inverseKey]][linkKey]!==type)throw new Error('The value for "'+linkKey+'" on "'+field+'" in type "'+type+'" is invalid, the inversely related field must define its link as "'+type+'".')}else denormalizedField=denormalizedPrefix+type+denormalizedDelimiter+field+denormalizedPostfix,Object.defineProperty(definition,inverseKey,{value:denormalizedField}),denormalizedDefinition={},denormalizedDefinition[linkKey]=type,denormalizedDefinition[inverseKey]=field,denormalizedDefinition[isArrayKey]=!0,denormalizedDefinition[denormalizedInverseKey]=!0,Object.defineProperty(linkedFields,denormalizedField,{value:denormalizedDefinition})}}},{"../common/keys":24}],45:[function(require,module,exports){(function(Buffer){"use strict";function validateField(value,key){if("object"!=typeof value||value.constructor!==Object)throw new TypeError('The definition of "'+key+'" must be an object.');if(key===primaryKey)throw new Error('Can not define primary key "'+primaryKey+'".');if(key in plainObject)throw new Error('Can not define "'+key+'" which is in Object.prototype.');if(!value[typeKey]&&!value[linkKey])throw new Error('The definition of "'+key+'" must contain either the "'+typeKey+'" or "'+linkKey+'" property.');if(value[typeKey]&&value[linkKey])throw new Error('Can not define both "'+typeKey+'" and "'+linkKey+'" on "'+key+'".');if(value[typeKey]){if(!find(nativeTypes,function(type){return type===value[typeKey]})&&"function"!=typeof value[typeKey])throw new Error('The "'+typeKey+'" on "'+key+'" is invalid.');if(value[inverseKey])throw new Error('The field "'+inverseKey+'" may not be defined on "'+key+'".')}if(value[linkKey]){if("string"!=typeof value[linkKey])throw new TypeError('The "'+linkKey+'" on "'+key+'" must be a string.');if(value[inverseKey]&&"string"!=typeof value[inverseKey])throw new TypeError('The "'+inverseKey+'" on "'+key+'" must be a string.')}if(value[isArrayKey]&&"boolean"!=typeof value[isArrayKey])throw new TypeError('The key "'+isArrayKey+'" on "'+key+'" must be a boolean.')}var find=require("../common/array/find"),keys=require("../common/keys"),primaryKey=keys.primary,typeKey=keys.type,linkKey=keys.link,inverseKey=keys.inverse,isArrayKey=keys.isArray,nativeTypes=[String,Number,Boolean,Date,Object,Buffer],plainObject={};module.exports=function(fields){var key;if("object"!=typeof fields)throw new TypeError("Type definition must be an object.");for(key in fields)validateField(fields[key],key)}}).call(this,require("buffer").Buffer)},{"../common/array/find":11,"../common/keys":24,buffer:47}],46:[function(require,module,exports){"use strict";function init(){for(var code="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=0,len=code.length;len>i;++i)lookup[i]=code[i],revLookup[code.charCodeAt(i)]=i;revLookup["-".charCodeAt(0)]=62,revLookup["_".charCodeAt(0)]=63}function toByteArray(b64){var i,j,l,tmp,placeHolders,arr,len=b64.length;if(len%4>0)throw new Error("Invalid string. Length must be a multiple of 4");placeHolders="="===b64[len-2]?2:"="===b64[len-1]?1:0,arr=new Arr(3*len/4-placeHolders),l=placeHolders>0?len-4:len;var L=0;for(i=0,j=0;l>i;i+=4,j+=3)tmp=revLookup[b64.charCodeAt(i)]<<18|revLookup[b64.charCodeAt(i+1)]<<12|revLookup[b64.charCodeAt(i+2)]<<6|revLookup[b64.charCodeAt(i+3)],arr[L++]=tmp>>16&255,arr[L++]=tmp>>8&255,arr[L++]=255&tmp;return 2===placeHolders?(tmp=revLookup[b64.charCodeAt(i)]<<2|revLookup[b64.charCodeAt(i+1)]>>4,arr[L++]=255&tmp):1===placeHolders&&(tmp=revLookup[b64.charCodeAt(i)]<<10|revLookup[b64.charCodeAt(i+1)]<<4|revLookup[b64.charCodeAt(i+2)]>>2,arr[L++]=tmp>>8&255,arr[L++]=255&tmp),arr}function tripletToBase64(num){return lookup[num>>18&63]+lookup[num>>12&63]+lookup[num>>6&63]+lookup[63&num]}function encodeChunk(uint8,start,end){for(var tmp,output=[],i=start;end>i;i+=3)tmp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2],output.push(tripletToBase64(tmp));return output.join("")}function fromByteArray(uint8){for(var tmp,len=uint8.length,extraBytes=len%3,output="",parts=[],maxChunkLength=16383,i=0,len2=len-extraBytes;len2>i;i+=maxChunkLength)parts.push(encodeChunk(uint8,i,i+maxChunkLength>len2?len2:i+maxChunkLength));return 1===extraBytes?(tmp=uint8[len-1],output+=lookup[tmp>>2],output+=lookup[tmp<<4&63],output+="=="):2===extraBytes&&(tmp=(uint8[len-2]<<8)+uint8[len-1],output+=lookup[tmp>>10],output+=lookup[tmp>>4&63],output+=lookup[tmp<<2&63],output+="="),parts.push(output),parts.join("")}exports.toByteArray=toByteArray,exports.fromByteArray=fromByteArray;var lookup=[],revLookup=[],Arr="undefined"!=typeof Uint8Array?Uint8Array:Array;init()},{}],47:[function(require,module,exports){(function(global){"use strict";function typedArraySupport(){try{var arr=new Uint8Array(1);return arr.foo=function(){return 42},42===arr.foo()&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function createBuffer(that,length){if(kMaxLength()<length)throw new RangeError("Invalid typed array length");return Buffer.TYPED_ARRAY_SUPPORT?(that=new Uint8Array(length),that.__proto__=Buffer.prototype):(null===that&&(that=new Buffer(length)),that.length=length),that}function Buffer(arg,encodingOrOffset,length){if(!(Buffer.TYPED_ARRAY_SUPPORT||this instanceof Buffer))return new Buffer(arg,encodingOrOffset,length);if("number"==typeof arg){if("string"==typeof encodingOrOffset)throw new Error("If encoding is specified then the first argument must be a string");return allocUnsafe(this,arg)}return from(this,arg,encodingOrOffset,length)}function from(that,value,encodingOrOffset,length){if("number"==typeof value)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&value instanceof ArrayBuffer?fromArrayBuffer(that,value,encodingOrOffset,length):"string"==typeof value?fromString(that,value,encodingOrOffset):fromObject(that,value)}function assertSize(size){if("number"!=typeof size)throw new TypeError('"size" argument must be a number')}function alloc(that,size,fill,encoding){return assertSize(size),0>=size?createBuffer(that,size):void 0!==fill?"string"==typeof encoding?createBuffer(that,size).fill(fill,encoding):createBuffer(that,size).fill(fill):createBuffer(that,size)}function allocUnsafe(that,size){if(assertSize(size),that=createBuffer(that,0>size?0:0|checked(size)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;size>i;i++)that[i]=0;return that}function fromString(that,string,encoding){if("string"==typeof encoding&&""!==encoding||(encoding="utf8"),!Buffer.isEncoding(encoding))throw new TypeError('"encoding" must be a valid string encoding');var length=0|byteLength(string,encoding);return that=createBuffer(that,length),that.write(string,encoding),that}function fromArrayLike(that,array){var length=0|checked(array.length);that=createBuffer(that,length);for(var i=0;length>i;i+=1)that[i]=255&array[i];return that}function fromArrayBuffer(that,array,byteOffset,length){if(array.byteLength,0>byteOffset||array.byteLength<byteOffset)throw new RangeError("'offset' is out of bounds");if(array.byteLength<byteOffset+(length||0))throw new RangeError("'length' is out of bounds");return array=void 0===length?new Uint8Array(array,byteOffset):new Uint8Array(array,byteOffset,length),Buffer.TYPED_ARRAY_SUPPORT?(that=array,that.__proto__=Buffer.prototype):that=fromArrayLike(that,array),that}function fromObject(that,obj){if(Buffer.isBuffer(obj)){var len=0|checked(obj.length);return that=createBuffer(that,len),0===that.length?that:(obj.copy(that,0,0,len),that)}if(obj){if("undefined"!=typeof ArrayBuffer&&obj.buffer instanceof ArrayBuffer||"length"in obj)return"number"!=typeof obj.length||isnan(obj.length)?createBuffer(that,0):fromArrayLike(that,obj);if("Buffer"===obj.type&&isArray(obj.data))return fromArrayLike(that,obj.data)}throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function SlowBuffer(length){return+length!=length&&(length=0),Buffer.alloc(+length)}function byteLength(string,encoding){if(Buffer.isBuffer(string))return string.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(string)||string instanceof ArrayBuffer))return string.byteLength;"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"binary":case"raw":case"raws":return len;case"utf8":case"utf-8":case void 0:return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if((void 0===start||0>start)&&(start=0),start>this.length)return"";if((void 0===end||end>this.length)&&(end=this.length),0>=end)return"";if(end>>>=0,start>>>=0,start>=end)return"";for(encoding||(encoding="utf8");;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function swap(b,n,m){var i=b[n];b[n]=b[m],b[m]=i}function arrayIndexOf(arr,val,byteOffset,encoding){function read(buf,i){return 1===indexSize?buf[i]:buf.readUInt16BE(i*indexSize)}var indexSize=1,arrLength=arr.length,valLength=val.length;if(void 0!==encoding&&(encoding=String(encoding).toLowerCase(),"ucs2"===encoding||"ucs-2"===encoding||"utf16le"===encoding||"utf-16le"===encoding)){if(arr.length<2||val.length<2)return-1;indexSize=2,arrLength/=2,valLength/=2,byteOffset/=2}for(var foundIndex=-1,i=0;arrLength>byteOffset+i;i++)if(read(arr,byteOffset+i)===read(val,-1===foundIndex?0:i-foundIndex)){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===valLength)return(byteOffset+foundIndex)*indexSize}else-1!==foundIndex&&(i-=i-foundIndex),foundIndex=-1;return-1}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length),length>remaining&&(length=remaining)):length=remaining;var strLen=string.length;if(strLen%2!==0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;length>i;i++){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))return i;buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;end>i;){var firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(end>=i+bytesPerSequence){var secondByte,thirdByte,fourthByte,tempCodePoint;switch(bytesPerSequence){case 1:128>firstByte&&(codePoint=firstByte);break;case 2:secondByte=buf[i+1],128===(192&secondByte)&&(tempCodePoint=(31&firstByte)<<6|63&secondByte,tempCodePoint>127&&(codePoint=tempCodePoint));break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128===(192&secondByte)&&128===(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte,tempCodePoint>2047&&(55296>tempCodePoint||tempCodePoint>57343)&&(codePoint=tempCodePoint));break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128===(192&secondByte)&&128===(192&thirdByte)&&128===(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte,tempCodePoint>65535&&1114112>tempCodePoint&&(codePoint=tempCodePoint))}}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return decodeCodePointsArray(res)}function decodeCodePointsArray(codePoints){var len=codePoints.length;if(MAX_ARGUMENTS_LENGTH>=len)return String.fromCharCode.apply(String,codePoints);for(var res="",i=0;len>i;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(127&buf[i]);return ret}function binarySlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;end>i;i++)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||0>start)&&(start=0),(!end||0>end||end>len)&&(end=len);for(var out="",i=start;end>i;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!==0||0>offset)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError('"buffer" argument must be a Buffer instance');if(value>max||min>value)throw new RangeError('"value" argument is out of bounds');if(offset+ext>buf.length)throw new RangeError("Index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){0>value&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);j>i;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){0>value&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);j>i;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(offset+ext>buf.length)throw new RangeError("Index out of range");if(0>offset)throw new RangeError("Index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,3.4028234663852886e38,-3.4028234663852886e38),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,1.7976931348623157e308,-1.7976931348623157e308),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}function base64clean(str){if(str=stringtrim(str).replace(INVALID_BASE64_RE,""),str.length<2)return"";for(;str.length%4!==0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function toHex(n){return 16>n?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){units=units||1/0;for(var codePoint,length=string.length,leadSurrogate=null,bytes=[],i=0;length>i;i++){if(codePoint=string.charCodeAt(i),codePoint>55295&&57344>codePoint){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(56320>codePoint){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=(leadSurrogate-55296<<10|codePoint-56320)+65536}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,128>codePoint){if((units-=1)<0)break;bytes.push(codePoint)}else if(2048>codePoint){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(65536>codePoint){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(1114112>codePoint))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);i++)c=str.charCodeAt(i),hi=c>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;length>i&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}function isnan(val){return val!==val}var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),exports.kMaxLength=kMaxLength(),Buffer.poolSize=8192,Buffer._augment=function(arr){return arr.__proto__=Buffer.prototype,arr},Buffer.from=function(value,encodingOrOffset,length){return from(null,value,encodingOrOffset,length)},Buffer.TYPED_ARRAY_SUPPORT&&(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array,"undefined"!=typeof Symbol&&Symbol.species&&Buffer[Symbol.species]===Buffer&&Object.defineProperty(Buffer,Symbol.species,{value:null,configurable:!0})),Buffer.alloc=function(size,fill,encoding){return alloc(null,size,fill,encoding)},Buffer.allocUnsafe=function(size){return allocUnsafe(null,size)},Buffer.allocUnsafeSlow=function(size){return allocUnsafe(null,size)},Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);len>i;++i)if(a[i]!==b[i]){x=a[i],y=b[i];break}return y>x?-1:x>y?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError('"list" argument must be an Array of Buffers');if(0===list.length)return Buffer.alloc(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;i++)length+=list[i].length;var buffer=Buffer.allocUnsafe(length),pos=0;for(i=0;i<list.length;i++){var buf=list[i];if(!Buffer.isBuffer(buf))throw new TypeError('"list" argument must be an Array of Buffers');buf.copy(buffer,pos),pos+=buf.length}return buffer},Buffer.byteLength=byteLength,Buffer.prototype._isBuffer=!0,Buffer.prototype.swap16=function(){var len=this.length;if(len%2!==0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var i=0;len>i;i+=2)swap(this,i,i+1);return this},Buffer.prototype.swap32=function(){var len=this.length;if(len%4!==0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var i=0;len>i;i+=4)swap(this,i,i+3),swap(this,i+1,i+2);return this},Buffer.prototype.toString=function(){var length=0|this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?!0:0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(target,start,end,thisStart,thisEnd){if(!Buffer.isBuffer(target))throw new TypeError("Argument must be a Buffer");if(void 0===start&&(start=0),void 0===end&&(end=target?target.length:0),void 0===thisStart&&(thisStart=0),void 0===thisEnd&&(thisEnd=this.length),0>start||end>target.length||0>thisStart||thisEnd>this.length)throw new RangeError("out of range index");if(thisStart>=thisEnd&&start>=end)return 0;if(thisStart>=thisEnd)return-1;if(start>=end)return 1;if(start>>>=0,end>>>=0,thisStart>>>=0,thisEnd>>>=0,this===target)return 0;for(var x=thisEnd-thisStart,y=end-start,len=Math.min(x,y),thisCopy=this.slice(thisStart,thisEnd),targetCopy=target.slice(start,end),i=0;len>i;++i)if(thisCopy[i]!==targetCopy[i]){x=thisCopy[i],y=targetCopy[i];break}return y>x?-1:x>y?1:0},Buffer.prototype.indexOf=function(val,byteOffset,encoding){if("string"==typeof byteOffset?(encoding=byteOffset,byteOffset=0):byteOffset>2147483647?byteOffset=2147483647:-2147483648>byteOffset&&(byteOffset=-2147483648),byteOffset>>=0,0===this.length)return-1;if(byteOffset>=this.length)return-1;if(0>byteOffset&&(byteOffset=Math.max(this.length+byteOffset,0)),"string"==typeof val&&(val=Buffer.from(val,encoding)),Buffer.isBuffer(val))return 0===val.length?-1:arrayIndexOf(this,val,byteOffset,encoding);if("number"==typeof val)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,val,byteOffset):arrayIndexOf(this,[val],byteOffset,encoding);throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.includes=function(val,byteOffset,encoding){return-1!==this.indexOf(val,byteOffset,encoding)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else{if(!isFinite(offset))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");offset=0|offset,isFinite(length)?(length=0|length,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0)}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(0>length||0>offset)||offset>this.length)throw new RangeError("Attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"binary":return binaryWrite(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;Buffer.prototype.slice=function(start,end){var len=this.length;start=~~start,end=void 0===end?len:~~end,0>start?(start+=len,0>start&&(start=0)):start>len&&(start=len),0>end?(end+=len,0>end&&(end=0)):end>len&&(end=len),start>end&&(end=start);var newBuf;if(Buffer.TYPED_ARRAY_SUPPORT)newBuf=this.subarray(start,end),newBuf.__proto__=Buffer.prototype;else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;sliceLen>i;i++)newBuf[i]=this[i+start]}return newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset=0|offset,byteLength=0|byteLength,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return mul*=128,val>=mul&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4);
},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,byteLength=0|byteLength,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,byteLength=0|byteLength,!noAssert){var maxBytes=Math.pow(2,8*byteLength)-1;checkInt(this,value,offset,byteLength,maxBytes,0)}var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)0>value&&0===sub&&0!==this[offset+i-1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset=0|offset,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)0>value&&0===sub&&0!==this[offset+i+1]&&(sub=1),this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),0>value&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset=0|offset,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),0>value&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&start>end&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(0>targetStart)throw new RangeError("targetStart out of bounds");if(0>start||start>=this.length)throw new RangeError("sourceStart out of bounds");if(0>end)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&targetStart>start&&end>targetStart)for(i=len-1;i>=0;i--)target[i+targetStart]=this[i+start];else if(1e3>len||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;len>i;i++)target[i+targetStart]=this[i+start];else Uint8Array.prototype.set.call(target,this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(val,start,end,encoding){if("string"==typeof val){if("string"==typeof start?(encoding=start,start=0,end=this.length):"string"==typeof end&&(encoding=end,end=this.length),1===val.length){var code=val.charCodeAt(0);256>code&&(val=code)}if(void 0!==encoding&&"string"!=typeof encoding)throw new TypeError("encoding must be a string");if("string"==typeof encoding&&!Buffer.isEncoding(encoding))throw new TypeError("Unknown encoding: "+encoding)}else"number"==typeof val&&(val=255&val);if(0>start||this.length<start||this.length<end)throw new RangeError("Out of range index");if(start>=end)return this;start>>>=0,end=void 0===end?this.length:end>>>0,val||(val=0);var i;if("number"==typeof val)for(i=start;end>i;i++)this[i]=val;else{var bytes=Buffer.isBuffer(val)?val:utf8ToBytes(new Buffer(val,encoding).toString()),len=bytes.length;for(i=0;end-start>i;i++)this[i+start]=bytes[i%len]}return this};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":46,ieee754:51,isarray:48}],48:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},{}],49:[function(require,module,exports){"use strict";function errorClass(name){if(!name||"string"!=typeof name)throw TypeError('Argument "name" must be a non-empty string.');var ErrorClass=Function("setupError","return function "+name+" () { if (!(this instanceof "+name+")) return new ("+name+".bind.apply("+name+", Array.prototype.concat.apply([ null ], arguments))); setupError.apply(this, arguments); }")(setupError);return ErrorClass.prototype=Object.create(Error.prototype,{constructor:nonEnumerableProperty(ErrorClass),name:nonEnumerableProperty(name)}),ErrorClass}function setupError(message){hasCaptureStackTrace?Error.captureStackTrace(this,this.constructor):Object.defineProperty(this,"stack",nonEnumerableProperty(Error(message).stack)),Object.defineProperty(this,"message",nonEnumerableProperty(void 0!==message?""+message:""))}function nonEnumerableProperty(value){return{value:value,writable:!0,configurable:!0}}var hasCaptureStackTrace="captureStackTrace"in Error;module.exports=errorClass},{}],50:[function(require,module,exports){function EventLite(){return this instanceof EventLite?void 0:new EventLite}!function(EventLite){function mixin(target){for(var key in methods)target[key]=methods[key];return target}function on(type,func){return getListeners(this,type).push(func),this}function once(type,func){function wrap(){off.call(that,type,wrap),func.apply(this,arguments)}var that=this;return wrap.originalListener=func,getListeners(that,type).push(wrap),that}function off(type,func){function ne(test){return test!==func&&test.originalListener!==func}var listners,that=this;if(arguments.length){if(func){if(listners=getListeners(that,type,!0)){if(listners=listners.filter(ne),!listners.length)return off.call(that,type);that[LISTENERS][type]=listners}}else if(listners=that[LISTENERS],listners&&(delete listners[type],!Object.keys(listners).length))return off.call(that)}else delete that[LISTENERS];return that}function emit(type,value){function zeroarg(func){func.call(that)}function onearg(func){func.call(that,value)}function moreargs(func){func.apply(that,args)}var that=this,listeners=getListeners(that,type,!0);if(!listeners)return!1;var arglen=arguments.length;if(1===arglen)listeners.forEach(zeroarg);else if(2===arglen)listeners.forEach(onearg);else{var args=Array.prototype.slice.call(arguments,1);listeners.forEach(moreargs)}return!!listeners.length}function getListeners(that,type,readonly){if(!readonly||that[LISTENERS]){var listeners=that[LISTENERS]||(that[LISTENERS]={});return listeners[type]||(listeners[type]=[])}}"undefined"!=typeof module&&(module.exports=EventLite);var LISTENERS="listeners",methods={on:on,once:once,off:off,emit:emit};mixin(EventLite.prototype),EventLite.mixin=mixin}(EventLite)},{}],51:[function(require,module,exports){exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:(s?-1:1)*(1/0);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=0>value||0===value&&0>1/value?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias),value*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],52:[function(require,module,exports){(function(Buffer){var Uint64BE,Int64BE;!function(exports){function init(that,buffer,offset,value,raddix){if(UINT8ARRAY&&ARRAYBUFFER&&(buffer instanceof ARRAYBUFFER&&(buffer=new UINT8ARRAY(buffer)),value instanceof ARRAYBUFFER&&(value=new UINT8ARRAY(value))),!(buffer||offset||value||storage))return void(that.buffer=newArray(ZERO,0));if(!isValidBuffer(buffer,offset)){var _storage=storage||Array;raddix=offset,value=buffer,offset=0,buffer=new _storage(8)}that.buffer=buffer,that.offset=offset|=0,"undefined"!=typeof value&&("string"==typeof value?fromString(buffer,offset,value,raddix||10):isValidBuffer(value,raddix)?fromArray(buffer,offset,value,raddix):"number"==typeof raddix?(writeUInt32BE(buffer,offset,value),writeUInt32BE(buffer,offset+4,raddix)):value>0?fromPositive(buffer,offset,value):0>value?fromNegative(buffer,offset,value):fromArray(buffer,offset,ZERO,0))}function isValidBuffer(buffer,offset){var len=buffer&&buffer.length;return offset|=0,len&&len>=offset+8&&"string"!=typeof buffer[offset]}function fromArray(destbuf,destoff,srcbuf,srcoff){destoff|=0,srcoff|=0;for(var i=0;8>i;i++)destbuf[destoff++]=255&srcbuf[srcoff++]}function fromString(buffer,offset,str,raddix){var pos=0,len=str.length,high=0,low=0;"-"===str[0]&&pos++;for(var sign=pos;len>pos;){var chr=parseInt(str[pos++],raddix);if(!(chr>=0))break;low=low*raddix+chr,high=high*raddix+Math.floor(low/BIT32),low%=BIT32}sign&&(high=~high,low?low=BIT32-low:high++),writeUInt32BE(buffer,offset,high),writeUInt32BE(buffer,offset+4,low)}function toString(buffer,offset,radix,signed){var str="",high=readUInt32BE(buffer,offset),low=readUInt32BE(buffer,offset+4),sign=signed&&2147483648&high;for(sign&&(high=~high,low=BIT32-low),radix=radix||10;;){var mod=high%radix*BIT32+low;if(high=Math.floor(high/radix),low=Math.floor(mod/radix),str=(mod%radix).toString(radix)+str,!high&&!low)break}return sign&&(str="-"+str),str}function newArray(buffer,offset){return Array.prototype.slice.call(buffer,offset,offset+8)}function readUInt32BE(buffer,offset){return buffer[offset++]*BIT24+(buffer[offset++]<<16)+(buffer[offset++]<<8)+buffer[offset]}function writeUInt32BE(buffer,offset,value){buffer[offset+3]=255&value,value>>=8,buffer[offset+2]=255&value,value>>=8,buffer[offset+1]=255&value,value>>=8,buffer[offset]=255&value}function fromPositive(buffer,offset,value){for(var i=offset+7;i>=offset;i--)buffer[i]=255&value,value/=256}function fromNegative(buffer,offset,value){value++;for(var i=offset+7;i>=offset;i--)buffer[i]=255&-value^255,value/=256}function _isArray(val){return!!val&&"[object Array]"==Object.prototype.toString.call(val)}var storage,U=exports.Uint64BE=Uint64BE=function(buffer,offset,value,raddix){return this instanceof Uint64BE?init(this,buffer,offset,value,raddix):new Uint64BE(buffer,offset,value,raddix)},I=exports.Int64BE=Int64BE=function(buffer,offset,value,raddix){return this instanceof Int64BE?init(this,buffer,offset,value,raddix):new Int64BE(buffer,offset,value,raddix)},UPROTO=U.prototype,IPROTO=I.prototype,UNDEFIND="undefined",BUFFER=UNDEFIND!==typeof Buffer&&Buffer,UINT8ARRAY=UNDEFIND!==typeof Uint8Array&&Uint8Array,ARRAYBUFFER=UNDEFIND!==typeof ArrayBuffer&&ArrayBuffer,ZERO=[0,0,0,0,0,0,0,0],isArray=Array.isArray||_isArray,BIT32=4294967296,BIT24=16777216;UPROTO.buffer=IPROTO.buffer=void 0,UPROTO.offset=IPROTO.offset=0,UPROTO._isUint64BE=IPROTO._isInt64BE=!0,U.isUint64BE=function(b){return!(!b||!b._isUint64BE)},I.isInt64BE=function(b){return!(!b||!b._isInt64BE)},UPROTO.toNumber=function(){var buffer=this.buffer,offset=this.offset,high=readUInt32BE(buffer,offset),low=readUInt32BE(buffer,offset+4);return high?high*BIT32+low:low},IPROTO.toNumber=function(){var buffer=this.buffer,offset=this.offset,high=0|readUInt32BE(buffer,offset),low=readUInt32BE(buffer,offset+4);return high?high*BIT32+low:low},UPROTO.toArray=IPROTO.toArray=function(raw){var buffer=this.buffer,offset=this.offset;return storage=null,raw!==!1&&0===offset&&8===buffer.length&&isArray(buffer)?buffer:newArray(buffer,offset)},BUFFER&&(UPROTO.toBuffer=IPROTO.toBuffer=function(raw){var buffer=this.buffer,offset=this.offset;if(storage=BUFFER,raw!==!1&&0===offset&&8===buffer.length&&Buffer.isBuffer(buffer))return buffer;var dest=new BUFFER(8);return fromArray(dest,0,buffer,offset),dest}),UINT8ARRAY&&(UPROTO.toArrayBuffer=IPROTO.toArrayBuffer=function(raw){var buffer=this.buffer,offset=this.offset,arrbuf=buffer.buffer;if(storage=UINT8ARRAY,raw!==!1&&0===offset&&arrbuf instanceof ARRAYBUFFER&&8===arrbuf.byteLength)return arrbuf;var dest=new UINT8ARRAY(8);return fromArray(dest,0,buffer,offset),dest.buffer}),IPROTO.toString=function(radix){return toString(this.buffer,this.offset,radix,!0)},UPROTO.toString=function(radix){return toString(this.buffer,this.offset,radix,!1)},UPROTO.toJSON=UPROTO.toNumber,IPROTO.toJSON=IPROTO.toNumber}("object"==typeof exports&&"string"!=typeof exports.nodeName?exports:this||{})}).call(this,require("buffer").Buffer)},{buffer:47}],53:[function(require,module,exports){module.exports=function(obj){return!(null==obj||!(obj._isBuffer||obj.constructor&&"function"==typeof obj.constructor.isBuffer&&obj.constructor.isBuffer(obj)))}},{}],54:[function(require,module,exports){exports.encode=require("./encode").encode,exports.decode=require("./decode").decode,exports.Encoder=require("./encoder").Encoder,exports.Decoder=require("./decoder").Decoder,exports.createCodec=require("./ext").createCodec,exports.codec=require("./codec").codec},{"./codec":57,"./decode":59,"./decoder":60,"./encode":62,"./encoder":63,"./ext":66}],55:[function(require,module,exports){function writeString(string,start){for(var buffer=this,index=start||0,length=string.length,i=0;length>i;i++){var chr=string.charCodeAt(i);128>chr?buffer[index++]=chr:2048>chr?(buffer[index++]=192|chr>>6,buffer[index++]=128|63&chr):(buffer[index++]=224|chr>>12,buffer[index++]=128|chr>>6&63,buffer[index++]=128|63&chr)}return index-start}function readString(start,end){var buffer=this,index=start-0||0;end||(end=buffer.length);var size=end-start;size>MAXBUFLEN&&(size=MAXBUFLEN);for(var out=[];end>index;){for(var array=new Array(size),pos=0;size>pos&&end>index;){var chr=buffer[index++];chr=128>chr?chr:224>chr?(63&chr)<<6|63&buffer[index++]:(63&chr)<<12|(63&buffer[index++])<<6|63&buffer[index++],array[pos++]=chr}size>pos&&(array=array.slice(0,pos)),out.push(String.fromCharCode.apply("",array))}return out.length>1?out.join(""):out.length?out.shift():""}function byteLength(string){var length=0;return Array.prototype.forEach.call(string,function(chr){var code=chr.charCodeAt(0);length+=128>code?1:2048>code?2:3}),length}function copy(target,targetStart,start,end){var i;start||(start=0),end||0===end||(end=this.length),targetStart||(targetStart=0);var len=end-start;if(target===this&&targetStart>start&&end>targetStart)for(i=len-1;i>=0;i--)target[i+targetStart]=this[i+start];else for(i=0;len>i;i++)target[i+targetStart]=this[i+start];return len}function writeUint64BE(value,offset){new Uint64BE(this,offset,value)}function writeInt64BE(value,offset){new Int64BE(this,offset,value)}var Int64Buffer=require("int64-buffer"),Uint64BE=Int64Buffer.Uint64BE,Int64BE=Int64Buffer.Int64BE,MAXBUFLEN=8192;exports.writeString=writeString,exports.readString=readString,exports.byteLength=byteLength,exports.copy=copy,exports.writeUint64BE=writeUint64BE,exports.writeInt64BE=writeInt64BE},{"int64-buffer":52}],56:[function(require,module,exports){function BufferShortageError(){}exports.BufferShortageError=BufferShortageError,BufferShortageError.prototype=Error.prototype},{}],57:[function(require,module,exports){exports.codec={preset:require("./ext").createCodec({preset:!0})}},{"./ext":66}],58:[function(require,module,exports){(function(Buffer){function DecodeBuffer(options){return this instanceof DecodeBuffer?void(options&&(this.options=options,options.codec&&(this.codec=options.codec))):new DecodeBuffer(options)}exports.DecodeBuffer=DecodeBuffer;var preset=require("./codec").codec.preset,BufferShortageError=require("./buffer-shortage").BufferShortageError;DecodeBuffer.prototype.offset=0,DecodeBuffer.prototype.push=function(chunk){var buffers=this.buffers||(this.buffers=[]);buffers.push(chunk)},DecodeBuffer.prototype.codec=preset,DecodeBuffer.prototype.write=function(chunk){var prev=this.offset?this.buffer.slice(this.offset):this.buffer;this.buffer=prev?chunk?Buffer.concat([prev,chunk]):prev:chunk,this.offset=0},DecodeBuffer.prototype.read=function(){var length=this.buffers&&this.buffers.length;return length?(this.flush(),this.pull()):this.fetch()},DecodeBuffer.prototype.pull=function(){var buffers=this.buffers||(this.buffers=[]);return buffers.shift()},DecodeBuffer.prototype.fetch=function(){return this.codec.decode(this)},DecodeBuffer.prototype.flush=function(){for(;this.offset<this.buffer.length;){var value,start=this.offset;try{value=this.fetch()}catch(e){if(!(e instanceof BufferShortageError))throw e;this.offset=start;break}this.push(value)}}}).call(this,require("buffer").Buffer)},{"./buffer-shortage":56,"./codec":57,buffer:47}],59:[function(require,module,exports){function decode(input,options){var decoder=new DecodeBuffer(options);return decoder.write(input),decoder.read()}exports.decode=decode;var DecodeBuffer=require("./decode-buffer").DecodeBuffer},{"./decode-buffer":58}],60:[function(require,module,exports){function Decoder(options){return this instanceof Decoder?void DecodeBuffer.call(this,options):new Decoder(options)}exports.Decoder=Decoder;var EventLite=require("event-lite"),DecodeBuffer=require("./decode-buffer").DecodeBuffer;Decoder.prototype=new DecodeBuffer,EventLite.mixin(Decoder.prototype),Decoder.prototype.decode=function(chunk){arguments.length&&this.write(chunk),this.flush()},Decoder.prototype.push=function(chunk){this.emit("data",chunk)},Decoder.prototype.end=function(chunk){this.decode(chunk),this.emit("end")}},{"./decode-buffer":58,"event-lite":50}],61:[function(require,module,exports){(function(Buffer){function EncodeBuffer(options){return this instanceof EncodeBuffer?void(options&&(this.options=options,options.codec&&(this.codec=options.codec))):new EncodeBuffer(options)}exports.EncodeBuffer=EncodeBuffer;var preset=require("./codec").codec.preset,MIN_BUFFER_SIZE=2048,MAX_BUFFER_SIZE=65536;EncodeBuffer.prototype.offset=0,EncodeBuffer.prototype.start=0,EncodeBuffer.prototype.push=function(chunk){var buffers=this.buffers||(this.buffers=[]);buffers.push(chunk)},EncodeBuffer.prototype.codec=preset,EncodeBuffer.prototype.write=function(input){this.codec.encode(this,input)},EncodeBuffer.prototype.read=function(){var length=this.buffers&&this.buffers.length;return length?(this.flush(),this.pull()):this.fetch()},EncodeBuffer.prototype.pull=function(){var buffers=this.buffers||(this.buffers=[]),chunk=buffers.length>1?Buffer.concat(buffers):buffers[0];return buffers.length=0,chunk},EncodeBuffer.prototype.fetch=function(){var start=this.start;return start<this.offset?(this.start=this.offset,this.buffer.slice(start,this.offset)):void 0},EncodeBuffer.prototype.flush=function(){var buffer=this.fetch();buffer&&this.push(buffer)},EncodeBuffer.prototype.reserve=function(length){if(this.buffer){var size=this.buffer.length;if(this.offset+length<size)return;this.flush(),length=Math.max(length,Math.min(2*size,MAX_BUFFER_SIZE))}length=length>MIN_BUFFER_SIZE?length:MIN_BUFFER_SIZE,this.buffer=new Buffer(length),this.start=0,this.offset=0},EncodeBuffer.prototype.send=function(buffer){var end=this.offset+buffer.length;this.buffer&&end<this.buffer.length?(buffer.copy(this.buffer,this.offset),this.offset=end):(this.flush(),this.push(buffer))}}).call(this,require("buffer").Buffer)},{"./codec":57,buffer:47}],62:[function(require,module,exports){function encode(input,options){var encoder=new EncodeBuffer(options);return encoder.write(input),encoder.read()}exports.encode=encode;var EncodeBuffer=require("./encode-buffer").EncodeBuffer},{"./encode-buffer":61}],63:[function(require,module,exports){function Encoder(options){return this instanceof Encoder?void EncodeBuffer.call(this,options):new Encoder(options)}exports.Encoder=Encoder;var EventLite=require("event-lite"),EncodeBuffer=require("./encode-buffer").EncodeBuffer;Encoder.prototype=new EncodeBuffer,EventLite.mixin(Encoder.prototype),Encoder.prototype.encode=function(chunk){this.write(chunk),this.emit("data",this.read())},Encoder.prototype.end=function(chunk){arguments.length&&this.encode(chunk),this.flush(),this.emit("end")}},{"./encode-buffer":61,"event-lite":50}],64:[function(require,module,exports){function ExtBuffer(buffer,type){return this instanceof ExtBuffer?(this.buffer=buffer,void(this.type=type)):new ExtBuffer(buffer,type)}exports.ExtBuffer=ExtBuffer},{}],65:[function(require,module,exports){(function(Buffer){function setExtPreset(codec){setExtPackers(codec),setExtUnpackers(codec)}function setExtPackers(preset){preset.addExtPacker(14,Error,[packError,encode]),preset.addExtPacker(1,EvalError,[packError,encode]),preset.addExtPacker(2,RangeError,[packError,encode]),preset.addExtPacker(3,ReferenceError,[packError,encode]),preset.addExtPacker(4,SyntaxError,[packError,encode]),preset.addExtPacker(5,TypeError,[packError,encode]),preset.addExtPacker(6,URIError,[packError,encode]),preset.addExtPacker(10,RegExp,[packRegExp,encode]),preset.addExtPacker(11,Boolean,[packValueOf,encode]),preset.addExtPacker(12,String,[packValueOf,encode]),preset.addExtPacker(13,Date,[Number,encode]),preset.addExtPacker(15,Number,[packValueOf,encode]),hasUint8Array&&(preset.addExtPacker(17,Int8Array,packBuffer),preset.addExtPacker(18,Uint8Array,packBuffer),preset.addExtPacker(19,Int16Array,packTypedArray),preset.addExtPacker(20,Uint16Array,packTypedArray),preset.addExtPacker(21,Int32Array,packTypedArray),preset.addExtPacker(22,Uint32Array,packTypedArray),preset.addExtPacker(23,Float32Array,packTypedArray),hasFloat64Array&&preset.addExtPacker(24,Float64Array,packTypedArray),hasUint8ClampedArray&&(preset.addExtPacker(25,Uint8ClampedArray,packBuffer),preset.addExtUnpacker(25,unpackClass(Uint8ClampedArray))),preset.addExtPacker(26,ArrayBuffer,packArrayBuffer),preset.addExtPacker(29,DataView,packTypedArray),preset.addExtUnpacker(26,unpackArrayBuffer),preset.addExtUnpacker(29,[unpackArrayBuffer,unpackClass(DataView)]))}function setExtUnpackers(preset){preset.addExtPacker(14,Error,[packError,encode]),preset.addExtPacker(1,EvalError,[packError,encode]),preset.addExtPacker(2,RangeError,[packError,encode]),preset.addExtPacker(3,ReferenceError,[packError,encode]),preset.addExtPacker(4,SyntaxError,[packError,encode]),preset.addExtPacker(5,TypeError,[packError,encode]),preset.addExtPacker(6,URIError,[packError,encode]),preset.addExtUnpacker(14,[decode,unpackError(Error)]),preset.addExtUnpacker(1,[decode,unpackError(EvalError)]),preset.addExtUnpacker(2,[decode,unpackError(RangeError)]),preset.addExtUnpacker(3,[decode,unpackError(ReferenceError)]),preset.addExtUnpacker(4,[decode,unpackError(SyntaxError)]),preset.addExtUnpacker(5,[decode,unpackError(TypeError)]),preset.addExtUnpacker(6,[decode,unpackError(URIError)]),preset.addExtPacker(10,RegExp,[packRegExp,encode]),preset.addExtPacker(11,Boolean,[packValueOf,encode]),preset.addExtPacker(12,String,[packValueOf,encode]),preset.addExtPacker(13,Date,[Number,encode]),preset.addExtPacker(15,Number,[packValueOf,encode]),preset.addExtUnpacker(10,[decode,unpackRegExp]),preset.addExtUnpacker(11,[decode,unpackClass(Boolean)]),preset.addExtUnpacker(12,[decode,unpackClass(String)]),preset.addExtUnpacker(13,[decode,unpackClass(Date)]),preset.addExtUnpacker(15,[decode,unpackClass(Number)]),hasUint8Array&&(preset.addExtPacker(17,Int8Array,packBuffer),preset.addExtPacker(18,Uint8Array,packBuffer),preset.addExtPacker(19,Int16Array,packTypedArray),preset.addExtPacker(20,Uint16Array,packTypedArray),preset.addExtPacker(21,Int32Array,packTypedArray),preset.addExtPacker(22,Uint32Array,packTypedArray),preset.addExtPacker(23,Float32Array,packTypedArray),preset.addExtUnpacker(17,unpackClass(Int8Array)),preset.addExtUnpacker(18,unpackClass(Uint8Array)),preset.addExtUnpacker(19,[unpackArrayBuffer,unpackClass(Int16Array)]),preset.addExtUnpacker(20,[unpackArrayBuffer,unpackClass(Uint16Array)]),preset.addExtUnpacker(21,[unpackArrayBuffer,unpackClass(Int32Array)]),preset.addExtUnpacker(22,[unpackArrayBuffer,unpackClass(Uint32Array)]),preset.addExtUnpacker(23,[unpackArrayBuffer,unpackClass(Float32Array)]),hasFloat64Array&&(preset.addExtPacker(24,Float64Array,packTypedArray),preset.addExtUnpacker(24,[unpackArrayBuffer,unpackClass(Float64Array)])),hasUint8ClampedArray&&(preset.addExtPacker(25,Uint8ClampedArray,packBuffer),preset.addExtUnpacker(25,unpackClass(Uint8ClampedArray))),preset.addExtPacker(26,ArrayBuffer,packArrayBuffer),preset.addExtPacker(29,DataView,packTypedArray),preset.addExtUnpacker(26,unpackArrayBuffer),preset.addExtUnpacker(29,[unpackArrayBuffer,unpackClass(DataView)]))}function encode(input){return _encode||(_encode=require("./encode").encode),_encode(input)}function decode(input){return _decode||(_decode=require("./decode").decode),_decode(input)}function packBuffer(value){return new Buffer(value)}function packValueOf(value){return value.valueOf()}function packRegExp(value){value=RegExp.prototype.toString.call(value).split("/"),value.shift();var out=[value.pop()];return out.unshift(value.join("/")),out}function unpackRegExp(value){return RegExp.apply(null,value)}function packError(value){var out={};for(var key in ERROR_COLUMNS)out[key]=value[key];return out}function unpackError(Class){return function(value){var out=new Class;for(var key in ERROR_COLUMNS)out[key]=value[key];return out}}function unpackClass(Class){return function(value){return new Class(value)}}function packTypedArray(value){return new Buffer(new Uint8Array(value.buffer))}function packArrayBuffer(value){return new Buffer(new Uint8Array(value))}function unpackArrayBuffer(value){return new Uint8Array(value).buffer}exports.setExtPreset=setExtPreset;var _encode,_decode,hasUint8Array="undefined"!=typeof Uint8Array,hasFloat64Array="undefined"!=typeof Float64Array,hasUint8ClampedArray="undefined"!=typeof Uint8ClampedArray,ERROR_COLUMNS={name:1,message:1,stack:1,columnNumber:1,fileName:1,lineNumber:1}}).call(this,require("buffer").Buffer)},{"./decode":59,"./encode":62,buffer:47}],66:[function(require,module,exports){function Codec(options){return this instanceof Codec?(this.extPackers={},this.extUnpackers=[],this.encode=WriteCore.getEncoder(options),this.decode=ReadCore.getDecoder(options),void(options&&options.preset&&ExtPreset.setExtPreset(this))):new Codec(options)}function createCodec(options){return new Codec(options)}function join(filters){function iterator(value,filter){return filter(value)}return filters=filters.slice(),function(value){return filters.reduce(iterator,value)}}var IS_ARRAY=require("isarray");exports.createCodec=createCodec;var ExtBuffer=require("./ext-buffer").ExtBuffer,ExtPreset=require("./ext-preset"),ReadCore=require("./read-core"),WriteCore=require("./write-core");Codec.prototype.addExtPacker=function(etype,Class,packer){function extPacker(value){var buffer=packer(value);return new ExtBuffer(buffer,etype)}IS_ARRAY(packer)&&(packer=join(packer));var name=Class.name;if(name&&"Object"!==name)this.extPackers[name]=extPacker;else{var list=this.extEncoderList||(this.extEncoderList=[]);list.unshift([Class,extPacker])}},Codec.prototype.addExtUnpacker=function(etype,unpacker){this.extUnpackers[etype]=IS_ARRAY(unpacker)?join(unpacker):unpacker},Codec.prototype.getExtPacker=function(value){var c=value.constructor,e=c&&c.name&&this.extPackers[c.name];if(e)return e;var list=this.extEncoderList;if(list)for(var len=list.length,i=0;len>i;i++){var pair=list[i];if(c===pair[0])return pair[1]}},Codec.prototype.getExtUnpacker=function(type){function extUnpacker(buffer){return new ExtBuffer(buffer,type)}return this.extUnpackers[type]||extUnpacker}},{"./ext-buffer":64,"./ext-preset":65,"./read-core":67,"./write-core":70,isarray:74}],67:[function(require,module,exports){function getDecoder(options){function decode(decoder){var type=readUint8(decoder),func=readToken[type];if(!func)throw new Error("Invalid type: "+(type?"0x"+type.toString(16):type));return func(decoder)}var readToken=ReadToken.getReadToken(options);return decode}exports.getDecoder=getDecoder;var readUint8=require("./read-format").readUint8,ReadToken=require("./read-token")},{"./read-format":68,"./read-token":69}],68:[function(require,module,exports){(function(Buffer){function getReadFormat(options){var readFormat={map:map,
array:array,str:str,bin:bin,ext:ext,uint8:uint8,uint16:uint16,uint32:read(4,Buffer.prototype.readUInt32BE),uint64:read(8,readUInt64BE),int8:read(1,Buffer.prototype.readInt8),int16:read(2,Buffer.prototype.readInt16BE),int32:read(4,Buffer.prototype.readInt32BE),int64:read(8,readInt64BE),float32:read(4,readFloatBE),float64:read(8,readDoubleBE)};return options&&options.int64&&(readFormat.uint64=read(8,readUInt64BE_int64),readFormat.int64=read(8,readInt64BE_int64)),readFormat}function map(decoder,len){var i,value={},k=new Array(len),v=new Array(len),decode=decoder.codec.decode;for(i=0;len>i;i++)k[i]=decode(decoder),v[i]=decode(decoder);for(i=0;len>i;i++)value[k[i]]=v[i];return value}function array(decoder,len){for(var value=new Array(len),decode=decoder.codec.decode,i=0;len>i;i++)value[i]=decode(decoder);return value}function str(decoder,len){var start=decoder.offset,end=decoder.offset=start+len,buffer=decoder.buffer;if(end>buffer.length)throw new BufferShortageError;return IS_BUFFER_SHIM||!Buffer.isBuffer(buffer)?BufferLite.readString.call(buffer,start,end):buffer.toString("utf-8",start,end)}function bin(decoder,len){var start=decoder.offset,end=decoder.offset=start+len;if(end>decoder.buffer.length)throw new BufferShortageError;return slice.call(decoder.buffer,start,end)}function ext(decoder,len){var start=decoder.offset,end=decoder.offset=start+len+1;if(end>decoder.buffer.length)throw new BufferShortageError;var type=decoder.buffer[start],unpack=decoder.codec.getExtUnpacker(type);if(!unpack)throw new Error("Invalid ext type: "+(type?"0x"+type.toString(16):type));var buf=slice.call(decoder.buffer,start+1,end);return unpack(buf)}function uint8(decoder){var buffer=decoder.buffer;if(decoder.offset>=buffer.length)throw new BufferShortageError;return buffer[decoder.offset++]}function uint16(decoder){var buffer=decoder.buffer;if(decoder.offset+2>buffer.length)throw new BufferShortageError;return buffer[decoder.offset++]<<8|buffer[decoder.offset++]}function read(len,method){return function(decoder){var start=decoder.offset,end=decoder.offset=start+len;if(end>decoder.buffer.length)throw new BufferShortageError;return method.call(decoder.buffer,start,NO_ASSERT)}}function readUInt64BE(start){return new Uint64BE(this,start).toNumber()}function readInt64BE(start){return new Int64BE(this,start).toNumber()}function readUInt64BE_int64(start){return new Uint64BE(this,start)}function readInt64BE_int64(start){return new Int64BE(this,start)}function readFloatBE(start){return this.readFloatBE?this.readFloatBE(start):ieee754.read(this,start,!1,23,4)}function readDoubleBE(start){return this.readDoubleBE?this.readDoubleBE(start):ieee754.read(this,start,!1,52,8)}function slice(start,end){var f=this.slice||Array.prototype.slice,buf=f.call(this,start,end);return Buffer.isBuffer(buf)||(buf=Buffer(buf)),buf}var ieee754=require("ieee754"),Int64Buffer=require("int64-buffer"),Uint64BE=Int64Buffer.Uint64BE,Int64BE=Int64Buffer.Int64BE;exports.getReadFormat=getReadFormat,exports.readUint8=uint8;var BufferLite=require("./buffer-lite"),BufferShortageError=require("./buffer-shortage").BufferShortageError,IS_BUFFER_SHIM="TYPED_ARRAY_SUPPORT"in Buffer,NO_ASSERT=!0}).call(this,require("buffer").Buffer)},{"./buffer-lite":55,"./buffer-shortage":56,buffer:47,ieee754:51,"int64-buffer":52}],69:[function(require,module,exports){function getReadToken(options){var format=ReadFormat.getReadFormat(options);return options&&options.useraw?init_useraw(format):init_token(format)}function init_token(format){var i,token=new Array(256);for(i=0;127>=i;i++)token[i]=constant(i);for(i=128;143>=i;i++)token[i]=fix(i-128,format.map);for(i=144;159>=i;i++)token[i]=fix(i-144,format.array);for(i=160;191>=i;i++)token[i]=fix(i-160,format.str);for(token[192]=constant(null),token[193]=null,token[194]=constant(!1),token[195]=constant(!0),token[196]=flex(format.uint8,format.bin),token[197]=flex(format.uint16,format.bin),token[198]=flex(format.uint32,format.bin),token[199]=flex(format.uint8,format.ext),token[200]=flex(format.uint16,format.ext),token[201]=flex(format.uint32,format.ext),token[202]=format.float32,token[203]=format.float64,token[204]=format.uint8,token[205]=format.uint16,token[206]=format.uint32,token[207]=format.uint64,token[208]=format.int8,token[209]=format.int16,token[210]=format.int32,token[211]=format.int64,token[212]=fix(1,format.ext),token[213]=fix(2,format.ext),token[214]=fix(4,format.ext),token[215]=fix(8,format.ext),token[216]=fix(16,format.ext),token[217]=flex(format.uint8,format.str),token[218]=flex(format.uint16,format.str),token[219]=flex(format.uint32,format.str),token[220]=flex(format.uint16,format.array),token[221]=flex(format.uint32,format.array),token[222]=flex(format.uint16,format.map),token[223]=flex(format.uint32,format.map),i=224;255>=i;i++)token[i]=constant(i-256);return token}function init_useraw(format){var i,token=getReadToken(format).slice();for(token[217]=token[196],token[218]=token[197],token[219]=token[198],i=160;191>=i;i++)token[i]=fix(i-160,format.bin);return token}function constant(value){return function(){return value}}function flex(lenFunc,decodeFunc){return function(decoder){var len=lenFunc(decoder);return decodeFunc(decoder,len)}}function fix(len,method){return function(decoder){return method(decoder,len)}}var ReadFormat=require("./read-format");exports.getReadToken=getReadToken},{"./read-format":68}],70:[function(require,module,exports){function getEncoder(options){function encode(encoder,value){var func=writeType[typeof value];if(!func)throw new Error('Unsupported type "'+typeof value+'": '+value);func(encoder,value)}var writeType=WriteType.getWriteType(options);return encode}exports.getEncoder=getEncoder;var WriteType=require("./write-type")},{"./write-type":72}],71:[function(require,module,exports){(function(Buffer){function getWriteToken(options){return NO_TYPED_ARRAY||options&&options.safe?init_safe():init_token()}function init_token(){var token=uint8.slice();return token[196]=write1(196),token[197]=write2(197),token[198]=write4(198),token[199]=write1(199),token[200]=write2(200),token[201]=write4(201),token[202]=writeN(202,4,Buffer.prototype.writeFloatBE,!0),token[203]=writeN(203,8,Buffer.prototype.writeDoubleBE,!0),token[204]=write1(204),token[205]=write2(205),token[206]=write4(206),token[207]=writeN(207,8,BufferLite.writeUint64BE),token[208]=write1(208),token[209]=write2(209),token[210]=write4(210),token[211]=writeN(211,8,BufferLite.writeUint64BE),token[217]=write1(217),token[218]=write2(218),token[219]=write4(219),token[220]=write2(220),token[221]=write4(221),token[222]=write2(222),token[223]=write4(223),token}function init_safe(){var token=uint8.slice();return token[196]=writeN(196,1,Buffer.prototype.writeUInt8),token[197]=writeN(197,2,Buffer.prototype.writeUInt16BE),token[198]=writeN(198,4,Buffer.prototype.writeUInt32BE),token[199]=writeN(199,1,Buffer.prototype.writeUInt8),token[200]=writeN(200,2,Buffer.prototype.writeUInt16BE),token[201]=writeN(201,4,Buffer.prototype.writeUInt32BE),token[202]=writeN(202,4,Buffer.prototype.writeFloatBE),token[203]=writeN(203,8,Buffer.prototype.writeDoubleBE),token[204]=writeN(204,1,Buffer.prototype.writeUInt8),token[205]=writeN(205,2,Buffer.prototype.writeUInt16BE),token[206]=writeN(206,4,Buffer.prototype.writeUInt32BE),token[207]=writeN(207,8,BufferLite.writeUint64BE),token[208]=writeN(208,1,Buffer.prototype.writeInt8),token[209]=writeN(209,2,Buffer.prototype.writeInt16BE),token[210]=writeN(210,4,Buffer.prototype.writeInt32BE),token[211]=writeN(211,8,BufferLite.writeUint64BE),token[217]=writeN(217,1,Buffer.prototype.writeUInt8),token[218]=writeN(218,2,Buffer.prototype.writeUInt16BE),token[219]=writeN(219,4,Buffer.prototype.writeUInt32BE),token[220]=writeN(220,2,Buffer.prototype.writeUInt16BE),token[221]=writeN(221,4,Buffer.prototype.writeUInt32BE),token[222]=writeN(222,2,Buffer.prototype.writeUInt16BE),token[223]=writeN(223,4,Buffer.prototype.writeUInt32BE),token}function write1(type){return function(encoder,value){encoder.reserve(2);var buffer=encoder.buffer,offset=encoder.offset;buffer[offset++]=type,buffer[offset++]=value,encoder.offset=offset}}function write2(type){return function(encoder,value){encoder.reserve(3);var buffer=encoder.buffer,offset=encoder.offset;buffer[offset++]=type,buffer[offset++]=value>>>8,buffer[offset++]=value,encoder.offset=offset}}function write4(type){return function(encoder,value){encoder.reserve(5);var buffer=encoder.buffer,offset=encoder.offset;buffer[offset++]=type,buffer[offset++]=value>>>24,buffer[offset++]=value>>>16,buffer[offset++]=value>>>8,buffer[offset++]=value,encoder.offset=offset}}function writeN(type,len,method,noAssert){return function(encoder,value){encoder.reserve(len+1),encoder.buffer[encoder.offset++]=type,method.call(encoder.buffer,value,encoder.offset,noAssert),encoder.offset+=len}}var BufferLite=require("./buffer-lite"),uint8=require("./write-uint8").uint8,IS_BUFFER_SHIM="TYPED_ARRAY_SUPPORT"in Buffer,NO_TYPED_ARRAY=IS_BUFFER_SHIM&&!Buffer.TYPED_ARRAY_SUPPORT;exports.getWriteToken=getWriteToken}).call(this,require("buffer").Buffer)},{"./buffer-lite":55,"./write-uint8":73,buffer:47}],72:[function(require,module,exports){(function(Buffer){function getWriteType(options){function bool(encoder,value){var type=value?195:194;token[type](encoder,value)}function number(encoder,value){var type,ivalue=0|value;return value!==ivalue?(type=203,void token[type](encoder,value)):(type=ivalue>=-32&&127>=ivalue?255&ivalue:ivalue>=0?255>=ivalue?204:65535>=ivalue?205:206:ivalue>=-128?208:ivalue>=-32768?209:210,void token[type](encoder,ivalue))}function uint64(encoder,value){var type=207;token[type](encoder,value.toArray())}function int64(encoder,value){var type=211;token[type](encoder,value.toArray())}function string(encoder,value){var length=value.length,maxsize=5+3*length;encoder.reserve(maxsize);var expected=32>length?1:255>=length?2:65535>=length?3:5,start=encoder.offset+expected;length=BufferLite.writeString.call(encoder.buffer,value,start);var actual=32>length?1:255>=length?2:65535>=length?3:5;expected!==actual&&move(encoder,start,length,actual-expected);var type=1===actual?160+length:3>=actual?215+actual:219;token[type](encoder,length),encoder.offset+=length}function object(encoder,value){if(null===value)return nil(encoder,value);if(Buffer.isBuffer(value))return bin(encoder,value);if(IS_ARRAY(value))return array(encoder,value);if(Uint64BE.isUint64BE(value))return uint64(encoder,value);if(Int64BE.isInt64BE(value))return int64(encoder,value);var packer=encoder.codec.getExtPacker(value);return packer&&(value=packer(value)),value instanceof ExtBuffer?ext(encoder,value):void map(encoder,value)}function nil(encoder,value){var type=192;token[type](encoder,value)}function array(encoder,value){var length=value.length,type=16>length?144+length:65535>=length?220:221;token[type](encoder,length);for(var encode=encoder.codec.encode,i=0;length>i;i++)encode(encoder,value[i])}function bin(encoder,value){var length=value.length,type=255>length?196:65535>=length?197:198;token[type](encoder,length),encoder.send(value)}function ext(encoder,value){var buffer=value.buffer,length=buffer.length,type=extmap[length]||(255>length?199:65535>=length?200:201);token[type](encoder,length),uint8[value.type](encoder),encoder.send(buffer)}function map(encoder,value){var keys=Object.keys(value),length=keys.length,type=16>length?128+length:65535>=length?222:223;token[type](encoder,length);var encode=encoder.codec.encode;keys.forEach(function(key){encode(encoder,key),encode(encoder,value[key])})}function string_raw(encoder,value){var length=value.length,maxsize=5+3*length;encoder.reserve(maxsize);var expected=32>length?1:65535>=length?3:5,start=encoder.offset+expected;length=BufferLite.writeString.call(encoder.buffer,value,start);var actual=32>length?1:65535>=length?3:5;expected!==actual&&move(encoder,start,length,actual-expected);var type=32>length?160+length:65535>=length?218:219;token[type](encoder,length),encoder.offset+=length}function object_raw(encoder,value){if(!Buffer.isBuffer(value))return object(encoder,value);var length=value.length,type=32>length?160+length:65535>=length?218:219;token[type](encoder,length),encoder.send(value)}var token=WriteToken.getWriteToken(options),writeType={"boolean":bool,"function":nil,number:number,object:object,string:string,symbol:nil,undefined:nil};return options&&options.useraw&&(writeType.object=object_raw,writeType.string=string_raw),writeType}function move(encoder,start,length,diff){var targetStart=start+diff,end=start+length;IS_BUFFER_SHIM?BufferLite.copy.call(encoder.buffer,encoder.buffer,targetStart,start,end):encoder.buffer.copy(encoder.buffer,targetStart,start,end)}var IS_ARRAY=require("isarray"),Int64Buffer=require("int64-buffer"),Uint64BE=Int64Buffer.Uint64BE,Int64BE=Int64Buffer.Int64BE,BufferLite=require("./buffer-lite"),WriteToken=require("./write-token"),uint8=require("./write-uint8").uint8,ExtBuffer=require("./ext-buffer").ExtBuffer,IS_BUFFER_SHIM="TYPED_ARRAY_SUPPORT"in Buffer,extmap=[];extmap[1]=212,extmap[2]=213,extmap[4]=214,extmap[8]=215,extmap[16]=216,exports.getWriteType=getWriteType}).call(this,require("buffer").Buffer)},{"./buffer-lite":55,"./ext-buffer":64,"./write-token":71,"./write-uint8":73,buffer:47,"int64-buffer":52,isarray:74}],73:[function(require,module,exports){function write0(type){return function(encoder){encoder.reserve(1),encoder.buffer[encoder.offset++]=type}}for(var constant=exports.uint8=new Array(256),i=0;255>=i;i++)constant[i]=write0(i)},{}],74:[function(require,module,exports){arguments[4][48][0].apply(exports,arguments)},{dup:48}]},{},[40]);
